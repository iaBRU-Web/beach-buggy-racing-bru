<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BRU KART RACING â€“ Beach Buggy Enhanced</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<!-- Rain canvas overlay -->
<div id="rainOverlay"><canvas id="rainCanvas"></canvas></div>

<canvas id="gc"></canvas>

<div id="hud" class="off">
  <div id="lapWrap"><div id="lapLabel">LAP</div><div id="lapNum">1 / 3</div></div>
  <div id="raceTimer">0:00</div>
  <div id="posBadge"><div id="posNum">1</div><div id="posSuffix">ST</div><div id="posOf">of 8</div></div>
  <div id="weatherBadge"><div id="weatherEmoji">â˜€ï¸</div><div id="weatherLabel">SUNNY</div></div>
  <div id="coinBadge">ğŸª™ <span id="hudCoins">0</span></div>
  <div id="statusBars">
    <div class="sbar"><div class="sbar-label"><span>ARMOR</span><span id="hpPct">100%</span></div><div class="sbar-track"><div class="sbar-fill" id="hpFill" style="width:100%"></div></div></div>
    <div class="sbar"><div class="sbar-label"><span>BOOST</span><span id="boostPct">100%</span></div><div class="sbar-track"><div class="sbar-fill" id="boostFill" style="width:100%"></div></div></div>
  </div>
  <div id="comboHUD"><div id="comboNum">0x</div><div id="comboLabel">DRIFT COMBO</div><div id="comboBonus">+0</div></div>
  <div id="speedoWrap"><canvas id="speedoCanvas" width="188" height="115"></canvas><div id="speedNum">0</div><div id="speedUnit">KM/H</div></div>
  <div id="mmWrap"><canvas id="mmCanvas" width="160" height="55"></canvas></div>
  <div id="itemBox" onclick="useItem()"><div id="itemEmoji">â“</div><div id="itemLabel">NO ITEM</div><div id="useHint">[SPACE]</div></div>
  <div id="countdown"><div id="cdNum" style="color:#FFD700">3</div></div>
  <div id="notif"></div>
  <div id="boostFlash"></div>
  <div id="speedLines"></div>
  <div id="damageFlash"></div>
  <div id="healFlash"></div>
  <div id="lapFlash"></div>
  <div id="driftHUD"><div id="driftBar"></div><div id="driftTxt">DRIFT BOOST</div></div>
  <div id="offroadWarn">âš  OFF ROAD</div>
  <div id="wrongWay">â†© WRONG WAY!</div>
  <div id="trackName"></div>
  <div id="bestLapBadge">ğŸ… BEST LAP: --:--</div>
</div>

<div id="winBanner">
  <div id="winText">ğŸ† YOU WIN!</div>
  <div id="winSub">RACE FINISHED</div>
  <button class="mbtn mbtn-gold" style="margin-top:30px" onclick="showResults()">SEE RESULTS â†’</button>
</div>

<!-- TITLE SCREEN -->
<div class="screen" id="titleScreen">
  <div id="ts-sun"></div>
  <div id="ts-ocean"><div class="wv wv1"></div><div class="wv wv2"></div><div class="wv wv3"></div></div>
  <div id="ts-palms"><span class="tpalm">ğŸŒ´</span><span class="tpalm">ğŸŒ´</span></div>
  <div id="vBadge">v3.0 ENHANCED</div>
  <div id="logo">BRU KART RACING</div>
  <div id="logo-sub">BEACH BUGGY EDITION</div>
  <div id="logo-tag">BY INEZA AIME BRUNO</div>
  <button class="mbtn mbtn-gold" onclick="startQuickRace()">ğŸ QUICK RACE</button>
  <button class="mbtn mbtn-gold" onclick="showScreen('champScreen')">ğŸ† CHAMPIONSHIP</button>
  <button class="mbtn mbtn-blue" onclick="showScreen('garageScreen')">ğŸš— GARAGE</button>
  <button class="mbtn mbtn-teal" onclick="showScreen('shopScreen')">ğŸ›’ SHOP</button>
  <button class="mbtn mbtn-purple" onclick="showScreen('challengeScreen')">âš¡ CHALLENGES</button>
  <button class="mbtn mbtn-dark" onclick="showScreen('settingsScreen')">âš™ï¸ SETTINGS</button>
  <div id="creditsLine">INEZA AIME BRUNO â€¢ 2025 | â†‘â†“ Gas/Brake  â†â†’ Steer  SHIFT Boost  SPACE Item  C=Camera  T=Trick  Esc=Pause</div>
</div>

<!-- CHAMPIONSHIP -->
<div class="screen off" id="champScreen">
  <div class="scr-title">ğŸ† CHAMPIONSHIP</div>
  <div class="cug" id="cupGrid"></div>
  <button class="mbtn mbtn-red back-btn" onclick="showScreen('titleScreen')">â† BACK</button>
</div>

<!-- GARAGE -->
<div class="screen off" id="garageScreen">
  <div class="scr-title">ğŸš— GARAGE</div>
  <div class="cg" id="carGrid"></div>
  <button class="mbtn mbtn-red back-btn" onclick="showScreen('titleScreen')">â† BACK</button>
</div>

<!-- SHOP -->
<div class="screen off" id="shopScreen">
  <div class="scr-title">ğŸ›’ SHOP</div>
  <p style="color:var(--neon);font-family:'Orbitron',sans-serif;font-size:15px;margin-bottom:18px">ğŸª™ <span id="shopCoins">0</span> COINS</p>
  <div class="sg" id="shopGrid"></div>
  <button class="mbtn mbtn-red back-btn" onclick="showScreen('titleScreen')">â† BACK</button>
</div>

<!-- NEW: CHALLENGES SCREEN -->
<div class="screen off" id="challengeScreen">
  <div class="scr-title">âš¡ DAILY CHALLENGES</div>
  <div id="challengeGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;max-width:700px;width:100%;padding:0 18px;margin-bottom:20px"></div>
  <button class="mbtn mbtn-red back-btn" onclick="showScreen('titleScreen')">â† BACK</button>
</div>

<!-- SETTINGS -->
<div class="screen off" id="settingsScreen">
  <div class="scr-title">âš™ï¸ SETTINGS</div>
  <div class="sr"><label>SOUND FX</label><button class="tog on" id="sfxT" onclick="toggleSFX()">ON</button></div>
  <div class="sr"><label>DIFFICULTY</label><select id="diffSel" onchange="saveSetting('difficulty',this.value)">
    <option value="easy">EASY</option><option value="medium" selected>MEDIUM</option><option value="hard">HARD</option>
  </select></div>
  <div class="sr"><label>CAMERA MODE</label><select id="camSel" onchange="saveSetting('camMode',this.value)">
    <option value="chase">CHASE</option><option value="low">LOW RIDER</option><option value="wide">WIDE</option>
  </select></div>
  <div class="sr"><label>SHOW SHADOWS</label><button class="tog on" id="shadowT" onclick="toggleShadows()">ON</button></div>
  <div class="sr"><label>WEATHER FX</label><button class="tog on" id="weatherT" onclick="toggleWeather()">ON</button></div>
  <div class="sr"><label>RESET PROGRESS</label><button class="mbtn mbtn-red" style="margin:0;padding:7px 18px;min-width:0;font-size:11px" onclick="resetProgress()">RESET</button></div>
  <button class="mbtn mbtn-red back-btn" onclick="showScreen('titleScreen')">â† BACK</button>
</div>

<!-- RESULTS -->
<div class="screen off" id="resultsScreen">
  <div class="rt-title" id="rTitle">ğŸ† VICTORY!</div>
  <div class="podRow" id="podiumRow"></div>
  <div class="reward" id="rewardBadge">+200 ğŸª™</div>
  <div id="statRow" style="display:flex;gap:18px;margin-bottom:14px;font-size:12px;color:rgba(255,255,255,.45);letter-spacing:1px"></div>
  <table class="rtab" id="rTable"></table>
  <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
    <button class="mbtn mbtn-gold" id="nextBtn" onclick="nextRace()" style="display:none">NEXT RACE â–¶</button>
    <button class="mbtn mbtn-blue" onclick="startQuickRace()">ğŸ”„ RACE AGAIN</button>
    <button class="mbtn mbtn-red" onclick="showScreen('titleScreen')">MAIN MENU</button>
  </div>
</div>

<!-- PAUSE -->
<div class="screen off" id="pauseScreen">
  <div class="scr-title">â¸ PAUSED</div>
  <div style="color:rgba(255,255,255,.4);font-size:12px;letter-spacing:2px;margin-bottom:20px" id="pauseStats"></div>
  <button class="mbtn mbtn-gold" onclick="resumeGame()">â–¶ RESUME</button>
  <button class="mbtn mbtn-blue" style="margin-top:8px" onclick="startQuickRace()">ğŸ”„ RESTART</button>
  <button class="mbtn mbtn-red" style="margin-top:8px" onclick="showScreen('titleScreen')">MAIN MENU</button>
</div>

<!-- TOUCH CONTROLS -->
<div id="touchCtrl">
  <div class="tpad dpad">
    <div></div><div class="db" id="db-f" ontouchstart="td.f=true" ontouchend="td.f=false" ontouchcancel="td.f=false">â–²</div><div></div>
    <div class="db" id="db-l" ontouchstart="td.l=true" ontouchend="td.l=false" ontouchcancel="td.l=false">â—„</div>
    <div class="db" id="db-b" ontouchstart="td.b=true" ontouchend="td.b=false" ontouchcancel="td.b=false">â–¼</div>
    <div class="db" id="db-r" ontouchstart="td.r=true" ontouchend="td.r=false" ontouchcancel="td.r=false">â–º</div>
  </div>
  <div class="actBtns">
    <button class="ab ab-boost" ontouchstart="td.boost=true" ontouchend="td.boost=false">âš¡ BOOST</button>
    <button class="ab ab-item" onclick="useItem()">ğŸ¯ ITEM</button>
  </div>
</div>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--gold:#FFD700;--neon:#00FFC8;--red:#FF2244;--panel:rgba(0,8,20,0.90);--r:12px}
body{background:#000;font-family:'Rajdhani',sans-serif;overflow:hidden;color:#fff;user-select:none;cursor:default}
canvas#gc{display:block;position:fixed;inset:0;width:100vw;height:100vh;z-index:0}
.screen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100}
.screen.off{display:none!important}

/* â”€â”€ TITLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#titleScreen{background:linear-gradient(170deg,#001830 0%,#002d55 40%,#001020 100%);overflow:hidden}
#ts-sun{position:absolute;top:7%;left:50%;transform:translateX(-50%);width:130px;height:130px;border-radius:50%;background:radial-gradient(circle,#FFFBE0 5%,#FFE566 35%,#FF9900 72%,#FF5500 100%);box-shadow:0 0 90px #FFD700,0 0 200px rgba(255,140,0,.45);animation:sPulse 3s ease-in-out infinite alternate}
@keyframes sPulse{from{box-shadow:0 0 80px #FFD700,0 0 160px rgba(255,140,0,.4)}to{box-shadow:0 0 110px #FFE066,0 0 240px rgba(255,200,0,.55)}}
#ts-ocean{position:absolute;bottom:0;left:0;right:0;height:42%;pointer-events:none;overflow:hidden}
.wv{position:absolute;bottom:0;left:-55%;width:210%;border-radius:50% 50% 0 0}
.wv1{height:100%;background:linear-gradient(180deg,#0077BB,#003366);animation:wvA 4s ease-in-out infinite;opacity:.92}
.wv2{height:76%;background:linear-gradient(180deg,#009ADD,#005599);animation:wvA 5.5s ease-in-out infinite reverse;opacity:.6}
.wv3{height:55%;background:linear-gradient(180deg,#00BBEE,#006688);animation:wvA 3.2s ease-in-out infinite;opacity:.42}
@keyframes wvA{0%,100%{transform:translateX(0)}50%{transform:translateX(-8%)}}
#ts-palms{position:absolute;bottom:38%;left:0;right:0;display:flex;justify-content:space-between;padding:0 6%;pointer-events:none}
.tpalm{font-size:100px;filter:drop-shadow(0 8px 16px rgba(0,0,0,.55));animation:pSway 4s ease-in-out infinite alternate}
.tpalm:last-child{animation-direction:alternate-reverse;animation-duration:5.2s}
@keyframes pSway{from{transform:rotate(-4deg)}to{transform:rotate(4deg)}}
#logo{font-family:'Orbitron',sans-serif;font-size:clamp(30px,6.5vw,84px);font-weight:900;letter-spacing:4px;text-align:center;z-index:10;background:linear-gradient(135deg,#FFE066,#FFD700,#FF8800,#FF3300,#FFD700);background-size:400%;animation:lgS 3s linear infinite;-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 32px rgba(255,200,0,.6));margin-bottom:5px}
@keyframes lgS{to{background-position:400% 0}}
#logo-sub{font-family:'Rajdhani',sans-serif;font-size:clamp(10px,1.5vw,17px);letter-spacing:11px;color:rgba(255,255,200,.48);margin-bottom:6px;z-index:10;text-align:center}
#logo-tag{font-family:'Rajdhani',sans-serif;font-size:13px;letter-spacing:3px;color:rgba(0,255,200,.58);margin-bottom:34px;z-index:10;text-align:center}
#creditsLine{font-family:'Rajdhani',sans-serif;font-size:10px;letter-spacing:2px;color:rgba(255,255,255,.16);position:absolute;bottom:7px;left:50%;transform:translateX(-50%);z-index:10;white-space:nowrap}

/* NEW: Version badge */
#vBadge{position:absolute;top:14px;right:14px;background:linear-gradient(135deg,#003355,#00FFC8);border-radius:20px;padding:4px 12px;font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:2px;color:#fff;z-index:10}

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mbtn{font-family:'Orbitron',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;padding:13px 40px;border-radius:50px;cursor:pointer;border:none;min-width:220px;margin:5px;text-transform:uppercase;position:relative;overflow:hidden;transition:transform .15s,box-shadow .2s;outline:none;z-index:10}
.mbtn::before{content:'';position:absolute;inset:0;background:rgba(255,255,255,.18);transform:translateX(-110%) skewX(-14deg);transition:transform .32s}
.mbtn:hover::before{transform:translateX(120%) skewX(-14deg)}
.mbtn:hover{transform:scale(1.06)}
.mbtn:active{transform:scale(.97)}
.mbtn-gold{background:linear-gradient(135deg,#996600,#FFD700,#FF9900);color:#000;box-shadow:0 4px 22px rgba(255,200,0,.38)}
.mbtn-gold:hover{box-shadow:0 6px 40px rgba(255,215,0,.7)}
.mbtn-blue{background:linear-gradient(135deg,#003366,#00AAFF,#0055BB);color:#fff}
.mbtn-red{background:linear-gradient(135deg,#550011,#FF2244,#880022);color:#fff}
.mbtn-dark{background:linear-gradient(135deg,#111,#222);color:#999;border:1.5px solid rgba(255,255,255,.1)}
.mbtn-teal{background:linear-gradient(135deg,#003322,#00CC88,#008855);color:#fff}
.mbtn-purple{background:linear-gradient(135deg,#220044,#AA00FF,#660099);color:#fff}

/* â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#hud{position:fixed;inset:0;pointer-events:none;z-index:50}
#lapWrap{position:absolute;top:14px;left:16px;background:var(--panel);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.1);border-radius:var(--r);padding:10px 18px}
#lapLabel{font-size:9px;letter-spacing:4px;color:rgba(255,255,255,.35)}
#lapNum{font-family:'Orbitron',sans-serif;font-size:26px;font-weight:900;color:var(--gold)}
#raceTimer{position:absolute;top:14px;left:50%;transform:translateX(-50%);font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700;background:var(--panel);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.08);border-radius:var(--r);padding:8px 20px;letter-spacing:3px}
#posBadge{position:absolute;top:14px;right:16px;text-align:center;background:var(--panel);backdrop-filter:blur(12px);border:1px solid rgba(255,215,0,.28);border-radius:var(--r);padding:10px 17px}
#posNum{font-family:'Orbitron',sans-serif;font-size:50px;font-weight:900;line-height:1;color:var(--gold);text-shadow:0 0 20px var(--gold)}
#posSuffix{font-family:'Orbitron',sans-serif;font-size:15px;color:var(--gold);opacity:.7}
#posOf{font-size:11px;color:rgba(255,255,255,.28);letter-spacing:1px;margin-top:3px}
#statusBars{position:absolute;top:84px;left:16px;width:188px}
.sbar{margin-bottom:9px}
.sbar-label{display:flex;justify-content:space-between;margin-bottom:3px;font-size:10px;letter-spacing:2px;color:rgba(255,255,255,.36)}
.sbar-track{height:10px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.07);overflow:hidden}
.sbar-fill{height:100%;border-radius:10px;transition:width .22s;position:relative;overflow:hidden}
.sbar-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shim 2s linear infinite}
@keyframes shim{from{transform:translateX(-100%)}to{transform:translateX(100%)}}
#hpFill{background:linear-gradient(90deg,#FF2244,#FF8800)}
#boostFill{background:linear-gradient(90deg,#0088FF,#00FFC8)}

/* NEW: Weather + Time HUD badge */
#weatherBadge{position:absolute;top:84px;right:16px;background:var(--panel);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.1);border-radius:var(--r);padding:8px 14px;text-align:center;font-size:22px;line-height:1}
#weatherLabel{font-size:8px;letter-spacing:2px;color:rgba(255,255,255,.3);margin-top:2px}

#coinBadge{position:absolute;top:130px;right:16px;background:var(--panel);backdrop-filter:blur(12px);border:1px solid rgba(255,215,0,.22);border-radius:var(--r);padding:8px 15px;font-family:'Orbitron',sans-serif;font-size:14px;color:var(--gold)}

/* NEW: Trick combo display */
#comboHUD{position:absolute;top:50%;right:16px;transform:translateY(-50%);text-align:right;pointer-events:none;opacity:0;transition:opacity .4s}
#comboHUD.show{opacity:1}
#comboNum{font-family:'Orbitron',sans-serif;font-size:44px;font-weight:900;color:#FF8800;text-shadow:0 0 30px #FF8800;line-height:1}
#comboLabel{font-size:9px;letter-spacing:3px;color:rgba(255,200,100,.6)}
#comboBonus{font-family:'Orbitron',sans-serif;font-size:13px;color:var(--neon)}

#speedoWrap{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);width:188px;height:115px}
#speedoCanvas{width:188px;height:115px}
#speedNum{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-family:'Orbitron',sans-serif;font-size:25px;font-weight:900;color:#fff;text-shadow:0 0 14px var(--neon);white-space:nowrap}
#speedUnit{position:absolute;bottom:2px;left:50%;transform:translateX(-50%);font-size:9px;letter-spacing:3px;color:rgba(255,255,255,.35)}
#mmWrap{position:absolute;bottom:14px;left:200px;width:160px;height:55px}
#mmCanvas{border-radius:8px;border:2px solid rgba(255,255,255,.18)}
#itemBox{position:absolute;bottom:14px;right:16px;width:90px;height:90px;border-radius:16px;pointer-events:auto;cursor:pointer;background:rgba(0,0,0,.7);border:2px solid rgba(255,255,255,.16);display:flex;flex-direction:column;align-items:center;justify-content:center;backdrop-filter:blur(10px);transition:border-color .2s,transform .1s}
#itemBox:hover{border-color:var(--gold);box-shadow:0 0 20px rgba(255,215,0,.3)}
#itemBox:active{transform:scale(.93)}
#itemEmoji{font-size:38px;line-height:1}
#itemLabel{font-size:8px;letter-spacing:1px;color:rgba(255,255,255,.36);margin-top:2px}
#useHint{font-size:7px;color:rgba(255,255,255,.2);margin-top:1px}

/* NEW: Track name announce */
#trackName{position:absolute;top:22%;left:50%;transform:translateX(-50%);font-family:'Orbitron',sans-serif;font-size:clamp(14px,3vw,28px);font-weight:900;color:#fff;letter-spacing:6px;opacity:0;text-shadow:0 0 30px rgba(255,255,255,.5);transition:opacity .5s;pointer-events:none;text-align:center}

#countdown{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
#cdNum{font-family:'Orbitron',sans-serif;font-size:clamp(90px,18vw,220px);font-weight:900;opacity:0;transform:scale(2.5);transition:opacity .12s,transform .45s cubic-bezier(.2,1.5,.4,1);filter:drop-shadow(0 0 60px currentColor)}
#cdNum.pop{opacity:1;transform:scale(1)}
#notif{position:absolute;top:35%;left:50%;transform:translate(-50%,-50%);font-family:'Orbitron',sans-serif;font-size:clamp(20px,4vw,44px);font-weight:900;text-align:center;opacity:0;transition:opacity .3s;pointer-events:none;text-shadow:0 0 28px currentColor;color:var(--gold)}
#boostFlash{position:absolute;inset:0;pointer-events:none;background:radial-gradient(ellipse at 50% 100%,rgba(0,255,200,.32),transparent 58%);opacity:0;transition:opacity .08s}
#speedLines{position:absolute;inset:0;pointer-events:none;opacity:0;background:repeating-linear-gradient(90deg,transparent,transparent 46%,rgba(255,255,255,.04) 50%,transparent 54%)}
#damageFlash{position:absolute;inset:0;pointer-events:none;background:rgba(255,30,50,.22);opacity:0;transition:opacity .05s}

/* NEW: heal flash */
#healFlash{position:absolute;inset:0;pointer-events:none;background:rgba(0,255,130,.1);opacity:0;transition:opacity .05s}

#lapFlash{position:fixed;inset:0;background:rgba(255,215,0,.13);pointer-events:none;z-index:55;opacity:0;transition:opacity .07s}
#driftHUD{position:absolute;bottom:130px;left:50%;transform:translateX(-50%);width:155px;height:36px;background:rgba(0,0,0,.55);border-radius:18px;border:2px solid rgba(255,136,0,.5);overflow:hidden;opacity:0;transition:opacity .18s;display:flex;align-items:center}
#driftBar{height:100%;width:0%;background:linear-gradient(90deg,#FF8800,#FFD700);transition:width .08s}
#driftTxt{position:absolute;width:100%;text-align:center;color:#fff;font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;pointer-events:none}
#offroadWarn{position:absolute;top:42%;left:50%;transform:translateX(-50%);font-family:'Orbitron',sans-serif;font-size:17px;color:#FF2244;text-shadow:0 0 10px #FF2244;opacity:0;transition:opacity .18s;pointer-events:none;letter-spacing:4px}

/* NEW: Rain overlay */
#rainOverlay{position:fixed;inset:0;pointer-events:none;z-index:48;opacity:0;transition:opacity 2s}
#rainCanvas{width:100%;height:100%}

/* NEW: Wrong way indicator */
#wrongWay{position:absolute;top:30%;left:50%;transform:translateX(-50%);font-family:'Orbitron',sans-serif;font-size:36px;font-weight:900;color:#FF2244;text-shadow:0 0 20px #FF2244,0 0 40px #FF2244;opacity:0;transition:opacity .2s;letter-spacing:4px;animation:wrongPulse 0.5s ease-in-out infinite alternate;pointer-events:none}
@keyframes wrongPulse{from{transform:translateX(-50%) scale(1)}to{transform:translateX(-50%) scale(1.07)}}

#winBanner{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.8);z-index:200;opacity:0;pointer-events:none;transition:opacity .6s;flex-direction:column}
#winBanner.show{opacity:1;pointer-events:auto}
#winText{font-family:'Orbitron',sans-serif;font-size:clamp(40px,9vw,108px);font-weight:900;background:linear-gradient(135deg,#FFD700,#FF9900,#FF4400);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 50px rgba(255,200,0,.9));animation:wPulse .7s ease-in-out infinite alternate;text-align:center}
@keyframes wPulse{from{transform:scale(1)}to{transform:scale(1.07)}}
#winSub{font-family:'Orbitron',sans-serif;font-size:15px;color:rgba(255,255,255,.55);margin-top:11px;letter-spacing:4px}

/* â”€â”€ TOUCH CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#touchCtrl{position:fixed;bottom:0;left:0;right:0;height:190px;display:none;justify-content:space-between;align-items:flex-end;padding:0 12px 12px;pointer-events:none;z-index:60}
.tpad{pointer-events:auto}
.dpad{display:grid;grid-template-columns:60px 60px 60px;grid-template-rows:60px 60px;gap:5px}
.db{display:flex;align-items:center;justify-content:center;font-size:22px;border-radius:14px;cursor:pointer;background:rgba(255,255,255,.08);border:1.5px solid rgba(255,255,255,.2);backdrop-filter:blur(8px);transition:background .1s}
.db:active,.db.pressed{background:rgba(255,255,255,.32)}
.actBtns{display:flex;flex-direction:column;gap:8px;pointer-events:auto}
.ab{padding:14px 17px;border-radius:14px;border:none;cursor:pointer;font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;transition:transform .1s,opacity .1s}
.ab:active{transform:scale(.94);opacity:.85}
.ab-boost{background:linear-gradient(135deg,#003355,#00FFC8);color:#fff}
.ab-item{background:linear-gradient(135deg,#664400,#FFD700);color:#000}

/* â”€â”€ RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#resultsScreen{background:radial-gradient(ellipse at 50% -10%,#001840,#000c1a 60%,#000);overflow-y:auto;padding:20px 0}
.rt-title{font-family:'Orbitron',sans-serif;font-size:clamp(22px,5vw,56px);font-weight:900;margin-bottom:10px}
.podRow{display:flex;gap:14px;align-items:flex-end;margin:14px 0}
.pPlace{text-align:center}
.pBox{border-radius:10px 10px 0 0;width:80px;display:flex;align-items:center;justify-content:center;font-size:21px;font-weight:900}
.rtab{width:100%;max-width:490px;border-collapse:collapse;font-size:13px;margin-bottom:14px}
.rtab th{color:rgba(255,255,255,.35);font-weight:400;letter-spacing:2px;border-bottom:1px solid rgba(255,255,255,.08);padding:7px 11px;font-size:11px}
.rtab td{padding:7px 11px;border-bottom:1px solid rgba(255,255,255,.05)}
.rtab tr.you td{color:var(--neon);font-weight:700}
.reward{background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.38);border-radius:var(--r);padding:11px 30px;font-family:'Orbitron',sans-serif;font-size:21px;color:var(--gold);margin-bottom:16px}

/* â”€â”€ SHOP / GARAGE / CHAMP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#shopScreen{overflow-y:auto;padding:75px 0 38px;background:radial-gradient(ellipse at 50% -10%,#001840,#000)}
.sg{display:grid;grid-template-columns:repeat(auto-fill,minmax(172px,1fr));gap:12px;max-width:800px;width:100%;padding:0 18px}
.si{background:rgba(255,255,255,.04);border:1.5px solid rgba(255,255,255,.1);border-radius:12px;padding:16px 13px;text-align:center;cursor:pointer;transition:all .2s}
.si:hover:not(.owned){border-color:rgba(255,215,0,.55);background:rgba(255,215,0,.07);transform:translateY(-3px)}
.si.owned{opacity:.44;cursor:default}
.si h4{font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:1px;color:var(--gold);margin-bottom:5px}
.si p{font-size:11px;color:rgba(255,255,255,.36);margin-bottom:10px;line-height:1.35}
.si-price{font-family:'Orbitron',sans-serif;font-size:13px;color:var(--neon);font-weight:700}

#garageScreen{background:radial-gradient(ellipse at 50% -10%,#001040,#000)}
.cg{display:grid;grid-template-columns:repeat(3,minmax(145px,1fr));gap:12px;max-width:540px;width:100%;padding:0 18px}
.cc{border:1.5px solid rgba(255,255,255,.1);border-radius:12px;padding:14px;text-align:center;cursor:pointer;transition:all .2s}
.cc:hover:not(.locked){border-color:rgba(255,215,0,.45);transform:translateY(-3px)}
.cc.sel{border-color:var(--gold);background:rgba(255,215,0,.08);box-shadow:0 0 20px rgba(255,215,0,.14)}
.cc.locked{opacity:.34;cursor:not-allowed}
.cpb{width:100%;height:56px;border-radius:9px;margin-bottom:9px}
.cc h4{font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:1px;color:var(--gold);margin-bottom:3px}
.spips{display:flex;gap:3px;justify-content:center;margin-top:5px}
.pip{width:10px;height:5px;border-radius:2px;background:rgba(255,255,255,.1)}
.pip.on{background:var(--neon)}

#champScreen{background:radial-gradient(ellipse at 50% 0%,#001230,#000)}
.cug{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;max-width:560px;width:100%;padding:0 18px}
.cuc{border:1.5px solid rgba(255,255,255,.1);border-radius:14px;padding:18px;text-align:center;cursor:pointer;transition:all .2s}
.cuc:hover:not(.lkd){border-color:rgba(255,215,0,.45);transform:translateY(-3px)}
.cuc.lkd{opacity:.3;cursor:not-allowed}
.cuc h3{font-family:'Orbitron',sans-serif;font-size:13px;letter-spacing:1px;color:var(--gold);margin-bottom:5px}

#settingsScreen{background:radial-gradient(ellipse at 50% 0%,#001030,#000)}
.sr{display:flex;align-items:center;justify-content:space-between;width:100%;max-width:400px;margin:7px 0;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:var(--r);padding:12px 18px}
.sr label{font-size:13px;color:rgba(255,255,255,.58);letter-spacing:1px}
.sr select{background:#111;color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:7px;padding:5px 10px;font-family:'Rajdhani',sans-serif;font-size:13px}
.tog{padding:7px 16px;border-radius:20px;cursor:pointer;font-size:11px;font-weight:700;letter-spacing:1px;border:1.5px solid rgba(255,255,255,.16);background:rgba(255,255,255,.05);color:rgba(255,255,255,.38);transition:all .2s}
.tog.on{border-color:var(--neon);color:var(--neon);background:rgba(0,255,200,.08)}
.scr-title{font-family:'Orbitron',sans-serif;font-size:clamp(17px,3vw,34px);font-weight:900;letter-spacing:3px;color:var(--gold);margin-bottom:20px}
.back-btn{margin-top:20px}

/* â”€â”€ DAMAGE FLOAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dmg{position:fixed;font-family:'Orbitron',sans-serif;font-size:21px;font-weight:900;pointer-events:none;z-index:65;animation:fltD 1.2s ease-out forwards}
@keyframes fltD{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-80px)}}
.dmg.hit{color:#FF2244;text-shadow:0 0 10px #FF2244}
.dmg.heal{color:#00FFC8;text-shadow:0 0 10px #00FFC8}
.dmg.coin{color:#FFD700;text-shadow:0 0 10px #FFD700;font-size:16px}

/* â”€â”€ PAUSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#pauseScreen{background:rgba(0,5,15,.88);backdrop-filter:blur(10px)}

/* â”€â”€ WHEEL SMOKE (CSS particle) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.smoke{position:fixed;pointer-events:none;border-radius:50%;background:rgba(255,255,255,.22);animation:smokeUp 1s ease-out forwards;z-index:45}
@keyframes smokeUp{0%{opacity:.7;transform:scale(1)}100%{opacity:0;transform:scale(4) translateY(-30px)}}

/* NEW: Ghost trail effect container */
#ghostTrail{position:fixed;inset:0;pointer-events:none;z-index:44}

/* NEW: Best lap badge */
#bestLapBadge{position:absolute;top:74px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#AA7700,#FFD700);border-radius:20px;padding:4px 16px;font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:2px;color:#000;opacity:0;transition:opacity .4s;white-space:nowrap}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘  BRU KART RACING v3.0 â€” Beach Buggy Enhanced               â•‘
// â•‘  New: Weather system Â· Drift combos Â· Ghost car            â•‘
// â•‘  Challenges Â· Camera modes Â· Trick system Â· Wrong Way      â•‘
// â•‘  Smooth physics Â· Strong AI Â· Particle FX                  â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Prevent canvas mouse interaction
const gcEl=document.getElementById('gc');
gcEl.addEventListener('mousedown',e=>e.preventDefault());
gcEl.addEventListener('contextmenu',e=>e.preventDefault());

const td={f:false,b:false,l:false,r:false,boost:false};

// â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SK='brukart_bb_v3';
let SD={
  coins:600,selectedCar:0,unlockedCars:[0,1],
  upgrades:{engine:0,handling:0,armor:0,boost:0},
  settings:{sfx:true,difficulty:'medium',camMode:'chase',shadows:true,weather:true},
  champ:{c0:0,c1:0,c2:0,c3:0},totalRaces:0,
  bestLaps:{},totalDrifts:0,totalCoins:0,challenges:{}
};
try{const s=localStorage.getItem(SK);if(s)SD=Object.assign(SD,JSON.parse(s));}catch(e){}
const save=()=>{try{localStorage.setItem(SK,JSON.stringify(SD));}catch(e){}};
function saveSetting(k,v){SD.settings[k]=v;save();}
function resetProgress(){if(confirm('Reset ALL progress?')){localStorage.removeItem(SK);location.reload();}}
function toggleSFX(){SD.settings.sfx=!SD.settings.sfx;const b=document.getElementById('sfxT');b.textContent=SD.settings.sfx?'ON':'OFF';b.className=SD.settings.sfx?'tog on':'tog';save();}
function toggleShadows(){SD.settings.shadows=!SD.settings.shadows;const b=document.getElementById('shadowT');b.textContent=SD.settings.shadows?'ON':'OFF';b.className=SD.settings.shadows?'tog on':'tog';renderer.shadowMap.enabled=SD.settings.shadows;save();}
function toggleWeather(){SD.settings.weather=!SD.settings.weather;const b=document.getElementById('weatherT');b.textContent=SD.settings.weather?'ON':'OFF';b.className=SD.settings.weather?'tog on':'tog';save();}

// â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let actx;
const getAC=()=>{if(!actx)actx=new(window.AudioContext||window.webkitAudioContext)();return actx;};
function tone(f,d=.12,tp='square',v=.18,sw=.5){
  if(!SD.settings.sfx)return;
  try{const ac=getAC(),o=ac.createOscillator(),g=ac.createGain();o.connect(g);g.connect(ac.destination);
  o.type=tp;o.frequency.setValueAtTime(f,ac.currentTime);o.frequency.exponentialRampToValueAtTime(f*sw,ac.currentTime+d);
  g.gain.setValueAtTime(v,ac.currentTime);g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+d);o.start();o.stop(ac.currentTime+d);}catch(e){}
}
const sfx={
  boost:  ()=>tone(320,.2,'sawtooth',.28,1.6),
  drift:  ()=>{if(Math.random()<.3)tone(260,.06,'sawtooth',.14,1.2);},
  pickup: ()=>{tone(700,.1,'sine',.22,1.8);setTimeout(()=>tone(1100,.1,'sine',.22,1.8),100);},
  hit:    ()=>tone(160,.3,'sawtooth',.4,.25),
  explode:()=>tone(80,.4,'sawtooth',.45,.2),
  lap:    ()=>[700,900,1200].forEach((f,i)=>setTimeout(()=>tone(f,.2,'sine',.32,1.05),i*120)),
  victory:()=>[523,659,784,1047,1319].forEach((f,i)=>setTimeout(()=>tone(f,.25,'sine',.4,1.05),i*150)),
  count:  n=>tone(n===0?1200:520,.35,'sine',.4,1.05),
  coin:   ()=>tone(880,.08,'sine',.15,1.2),
  trick:  ()=>{tone(440,.15,'sine',.3,1.5);setTimeout(()=>tone(660,.15,'sine',.3,1.5),80);setTimeout(()=>tone(880,.2,'sine',.3,1.5),160);}
};

// â”€â”€ Car Definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CARS=[
  {name:'Dune Rider',  col:0xFF6600,col2:0x883300,spd:6,acc:7,hdl:7,arm:6,bst:6,drift:7},
  {name:'Ocean Blaze', col:0x0099FF,col2:0x003388,spd:7,acc:6,hdl:8,arm:5,bst:7,drift:6},
  {name:'Jungle Fury', col:0x22CC44,col2:0x115522,spd:6,acc:8,hdl:7,arm:7,bst:7,drift:8,cost:250},
  {name:'Ice Breaker', col:0x88EEFF,col2:0x3399BB,spd:8,acc:5,hdl:6,arm:6,bst:8,drift:5,cost:450},
  {name:'Lava Lord',   col:0xFF2200,col2:0x770000,spd:7,acc:7,hdl:5,arm:9,bst:6,drift:9,cost:650},
  {name:'Storm Wing',  col:0xBB00FF,col2:0x660088,spd:9,acc:6,hdl:8,arm:4,bst:9,drift:7,cost:900},
  {name:'Desert Titan',col:0xDDAA00,col2:0x885500,spd:8,acc:7,hdl:6,arm:9,bst:7,drift:8,boss:true},
  {name:'BRU',         col:0xFFD700,col2:0x997700,spd:10,acc:9,hdl:9,arm:11,bst:10,drift:10,boss:true,final:true}
];

const POWERUPS=[
  {id:'fireball',name:'Fireball',e:'ğŸ”¥'},
  {id:'homing',  name:'Homing Orb',e:'ğŸ¯'},
  {id:'thunder', name:'Thunder',e:'âš¡'},
  {id:'banana',  name:'Banana',e:'ğŸŒ'},
  {id:'shield',  name:'Shield',e:'ğŸ›¡ï¸'},
  {id:'repair',  name:'Repair',e:'ğŸ’Š'},
  {id:'nitro',   name:'Nitro',e:'ğŸš€'},
  {id:'freeze',  name:'Freeze',e:'â„ï¸'},
  {id:'magnet',  name:'Magnet',e:'ğŸ§²'},
  {id:'triple',  name:'Triple Fire',e:'ğŸ”±'},  // NEW
  {id:'swap',    name:'Swap',e:'ğŸŒ€'},          // NEW
  {id:'oil',     name:'Oil Slick',e:'ğŸ›¢ï¸'},    // NEW
];

const CUPS=[
  {name:'Beach Cup ğŸ–ï¸',tracks:[0,0],laps:3,theme:0},
  {name:'Jungle Cup ğŸŒ¿',tracks:[1,1],laps:3,theme:1,boss:6},
  {name:'Desert Cup ğŸœï¸',tracks:[2,2],laps:3,theme:2,boss:6},
  {name:'Final Cup ğŸ‘‘',tracks:[3,3],laps:3,theme:3,boss:7}
];

const THEMES=[
  {name:'Sunny Beach',  sky:0x55AAEE,ground:0xF4D060,road:0xDDD8B0,road2:0xC8C4A0,fog:0x9EDBF5,side:'beach', weather:['sunny','cloudy','windy']},
  {name:'Jungle',       sky:0x1A4A1A,ground:0x3D6B2A,road:0x8A7A6A,road2:0x7A6A5A,fog:0x2D6030,side:'jungle',weather:['rain','thunderstorm','humid']},
  {name:'Desert',       sky:0xFF9A20,ground:0xD4A264,road:0xD4C4A0,road2:0xC4B490,fog:0xFFAA55,side:'desert',weather:['sunny','sandstorm','hot']},
  {name:'Arena',        sky:0x000022,ground:0x111133,road:0x222244,road2:0x1A1A38,fog:0x000033,side:'arena', weather:['clear','neon','electric']}
];

// NEW: Weather system
const WEATHERS={
  sunny:    {label:'â˜€ï¸ SUNNY',    rain:0,fogDensity:.0028,speedMod:1.0,   gripMod:1.0},
  cloudy:   {label:'â˜ï¸ CLOUDY',   rain:0,fogDensity:.004, speedMod:0.98,  gripMod:0.98},
  rain:     {label:'ğŸŒ§ï¸ RAIN',     rain:1,fogDensity:.006, speedMod:0.88,  gripMod:0.80},
  thunderstorm:{label:'â›ˆï¸ STORM', rain:2,fogDensity:.008, speedMod:0.82,  gripMod:0.72},
  windy:    {label:'ğŸ’¨ WINDY',    rain:0,fogDensity:.003, speedMod:0.92,  gripMod:0.95},
  sandstorm:{label:'ğŸœï¸ SANDSTORM',rain:0,fogDensity:.009,speedMod:0.85,  gripMod:0.88},
  hot:      {label:'ğŸ”¥ HOT',      rain:0,fogDensity:.003, speedMod:1.05,  gripMod:0.92},
  clear:    {label:'âœ¨ CLEAR',    rain:0,fogDensity:.002, speedMod:1.0,   gripMod:1.0},
  neon:     {label:'ğŸ’« NEON',     rain:0,fogDensity:.003, speedMod:1.02,  gripMod:1.0},
  electric: {label:'âš¡ ELECTRIC', rain:1,fogDensity:.005, speedMod:0.95,  gripMod:0.90},
  humid:    {label:'ğŸŒ«ï¸ HUMID',    rain:0,fogDensity:.007, speedMod:0.93,  gripMod:0.95},
};

// NEW: Daily challenges
const CHALLENGE_DEFS=[
  {id:'drift100',  name:'Drift Master',  desc:'Drift 100m in one race',   reward:200,goal:'driftDist',   target:100},
  {id:'combo5',    name:'Combo King',    desc:'Reach 5x drift combo',     reward:150,goal:'maxCombo',    target:5},
  {id:'1stplace',  name:'Gold Finish',   desc:'Finish 1st place',         reward:300,goal:'finishPos',   target:1},
  {id:'nohit',     name:'Clean Racer',   desc:'Finish race without being hit',reward:250,goal:'noHit',   target:1},
  {id:'boost10',   name:'Boost Fanatic', desc:'Use boost 10 times',       reward:120,goal:'boostCount',  target:10},
  {id:'coins50',   name:'Coin Collector',desc:'Collect 50 coins in race', reward:180,goal:'raceCoins',   target:50},
];

let currentWeather='sunny',weatherData=WEATHERS.sunny;
let rainParticles=[];

// NEW: Rain system
const rainCv=document.getElementById('rainCanvas');
const rainCtx=rainCv.getContext('2d');
function resizeRain(){rainCv.width=innerWidth;rainCv.height=innerHeight;}
window.addEventListener('resize',resizeRain);resizeRain();
function initRain(intensity){
  rainParticles=[];
  const count=intensity===2?300:150;
  for(let i=0;i<count;i++){
    rainParticles.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,spd:8+Math.random()*6,len:12+Math.random()*14,angle:intensity===2?0.3:0.15});
  }
}
function drawRain(dt){
  rainCtx.clearRect(0,0,rainCv.width,rainCv.height);
  if(!rainParticles.length)return;
  rainCtx.strokeStyle=weatherData.rain===2?'rgba(200,200,255,.55)':'rgba(180,200,255,.35)';
  rainCtx.lineWidth=1;
  rainParticles.forEach(p=>{
    rainCtx.beginPath();
    rainCtx.moveTo(p.x,p.y);
    rainCtx.lineTo(p.x+p.len*p.angle,p.y+p.len);
    rainCtx.stroke();
    p.y+=p.spd*dt*60;
    p.x+=p.spd*p.angle*dt*60;
    if(p.y>innerHeight){p.y=0;p.x=Math.random()*innerWidth;}
  });
}

const ROAD_LEN=2200,ROAD_W=28,FULL_W=ROAD_W*2,NUM_LANES=8,LANE_W=FULL_W/NUM_LANES;
const MAX_DRIFT=100;
let LAP_TOTAL=3;

// â”€â”€ Three.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas=document.getElementById('gc');
const renderer=new THREE.WebGLRenderer({canvas,antialias:true,powerPreference:'high-performance'});
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.shadowMap.enabled=true;
renderer.shadowMap.type=THREE.PCFSoftShadowMap;
renderer.toneMapping=THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure=1.12;
renderer.setSize(innerWidth,innerHeight);
window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});

const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(65,innerWidth/innerHeight,.1,1800);

// â”€â”€ Game state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let gState='menu',themeIdx=0,cupIdx=-1,raceInCup=0;
let raceTime=0,lapStartTime=0,bestLapTime=Infinity,lastLapTime=0;
let coinsEarned=0;
let racers=[],playerR=null;
let pickups=[],boostPads=[],bananas=[],oilSlicks=[],projectiles=[],fxList=[];
let shakeAmt=0,notifTimer=0;
let paused=false,offroadTimer=0;

// NEW: Race stats for challenges
let raceStats={driftDist:0,maxCombo:0,finishPos:8,noHit:true,boostCount:0,raceCoins:0};

// â”€â”€ Car Mesh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildCarMesh(def){
  const g=new THREE.Group();
  const mB=new THREE.MeshPhongMaterial({color:def.col,shininess:140,specular:0x555555});
  const mB2=new THREE.MeshPhongMaterial({color:def.col2||0x222222,shininess:80});
  const mD=new THREE.MeshPhongMaterial({color:0x111111,shininess:8});
  const mG=new THREE.MeshPhongMaterial({color:0x88CCFF,transparent:true,opacity:.5,shininess:200});
  const mC=new THREE.MeshPhongMaterial({color:0xDDDDDD,shininess:240,specular:0xFFFFFF});
  const mT=new THREE.MeshPhongMaterial({color:0x111111,shininess:4});
  const mR=new THREE.MeshPhongMaterial({color:0xCCCCCC,shininess:180});
  const mHL=new THREE.MeshPhongMaterial({color:0xFFFFAA,emissive:0xFFFF00,emissiveIntensity:.9});
  const mTL=new THREE.MeshPhongMaterial({color:0xFF2200,emissive:0xFF1100,emissiveIntensity:.9});

  const body=new THREE.Mesh(new THREE.BoxGeometry(2,.65,3.8),mB);body.position.y=.5;g.add(body);
  const cab=new THREE.Mesh(new THREE.BoxGeometry(1.72,.52,2.0),mB2);cab.position.set(0,1.12,-.05);g.add(cab);
  const wF=new THREE.Mesh(new THREE.BoxGeometry(1.56,.06,1.05),mG);wF.position.set(0,1.3,.88);wF.rotation.x=.42;g.add(wF);
  const wR=new THREE.Mesh(new THREE.BoxGeometry(1.56,.06,.9),mG);wR.position.set(0,1.24,-.82);wR.rotation.x=-.44;g.add(wR);
  const fb=new THREE.Mesh(new THREE.BoxGeometry(2.12,.28,.14),mC);fb.position.set(0,.62,1.97);g.add(fb);
  const rb=new THREE.Mesh(new THREE.BoxGeometry(2,.22,.14),mD);rb.position.set(0,.58,-1.97);g.add(rb);
  [-1.02,1.02].forEach(x=>{const s=new THREE.Mesh(new THREE.BoxGeometry(.05,.32,2.55),mB2);s.position.set(x,.68,0);g.add(s);});
  const hlL=new THREE.Mesh(new THREE.BoxGeometry(.38,.18,.08),mHL);hlL.position.set(-.74,.66,1.95);g.add(hlL);
  const hlR=hlL.clone();hlR.position.set(.74,.66,1.95);g.add(hlR);
  const tlL=new THREE.Mesh(new THREE.BoxGeometry(.3,.14,.07),mTL);tlL.position.set(-.72,.63,-1.95);g.add(tlL);
  const tlR=tlL.clone();tlR.position.set(.72,.63,-1.95);g.add(tlR);
  const ex=new THREE.Mesh(new THREE.CylinderGeometry(.07,.09,.48,8),mC);ex.rotation.x=Math.PI/2;ex.position.set(-.65,.46,-1.96);g.add(ex);
  const ant=new THREE.Mesh(new THREE.CylinderGeometry(.022,.022,.55,4),mD);ant.position.set(-.62,1.72,-.05);g.add(ant);
  if(def.boss||def.final){
    const s1=new THREE.Mesh(new THREE.BoxGeometry(.1,.48,.1),mC);s1.position.set(-.7,.9,-1.97);g.add(s1);
    const s2=s1.clone();s2.position.set(.7,.9,-1.97);g.add(s2);
    const wing=new THREE.Mesh(new THREE.BoxGeometry(2.1,.08,.5),mB);wing.position.set(0,1.16,-1.97);g.add(wing);
  }
  const wheels=[];
  [[- 1.18,.46,1.28],[1.18,.46,1.28],[-1.18,.46,-1.28],[1.18,.46,-1.28]].forEach(([wx,wy,wz])=>{
    const wg=new THREE.Group();
    const tyre=new THREE.Mesh(new THREE.CylinderGeometry(.46,.46,.38,14),mT);tyre.rotation.z=Math.PI/2;wg.add(tyre);
    const rim=new THREE.Mesh(new THREE.CylinderGeometry(.24,.24,.4,6),mR);rim.rotation.z=Math.PI/2;wg.add(rim);
    for(let i=0;i<5;i++){
      const a=(i/5)*Math.PI*2;
      const sp=new THREE.Mesh(new THREE.CylinderGeometry(.03,.03,.42,4),mD);
      sp.rotation.z=Math.PI/2;sp.position.set(Math.cos(a)*.12,Math.sin(a)*.12,0);wg.add(sp);
    }
    wg.position.set(wx,wy,wz);g.add(wg);wheels.push(wg);
  });
  g.userData.wheels=wheels;
  g.traverse(c=>{if(c.isMesh){c.castShadow=true;c.receiveShadow=true;}});
  return g;
}

// â”€â”€ Road Generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateRoad(T){
  while(scene.children.length>0)scene.remove(scene.children[0]);
  pickups=[];boostPads=[];bananas=[];oilSlicks=[];projectiles=[];fxList=[];

  scene.background=new THREE.Color(T.sky);
  scene.fog=new THREE.FogExp2(T.fog,weatherData.fogDensity);

  scene.add(new THREE.AmbientLight(0xFFFFFF,.55));
  const sun=new THREE.DirectionalLight(0xFFF8E0,1.5);
  sun.position.set(60,130,80);sun.castShadow=SD.settings.shadows;
  sun.shadow.mapSize.set(2048,2048);
  sun.shadow.camera.left=-300;sun.shadow.camera.right=300;
  sun.shadow.camera.top=80;sun.shadow.camera.bottom=-80;
  sun.shadow.camera.far=700;sun.shadow.bias=-.001;
  scene.add(sun);
  scene.add(new THREE.HemisphereLight(T.sky,T.ground,.4));
  if(T.side==='arena'){
    [0xFF2244,0x2244FF,0xFFD700,0x00FF88].forEach((c,i)=>{
      const lp=new THREE.PointLight(c,1.8,100);
      lp.position.set(Math.cos(i/4*Math.PI*2)*80,40,ROAD_LEN/2+Math.sin(i/4*Math.PI*2)*80);scene.add(lp);
    });
  }
  if(currentWeather==='neon'||currentWeather==='electric'){
    const nl=new THREE.PointLight(0x00FFC8,2.5,200);nl.position.set(0,50,ROAD_LEN/2);scene.add(nl);
    const nl2=new THREE.PointLight(0xFF44FF,2,200);nl2.position.set(0,40,ROAD_LEN/2);scene.add(nl2);
  }

  const gnd=new THREE.Mesh(new THREE.PlaneGeometry(ROAD_LEN+800,400),new THREE.MeshPhongMaterial({color:T.ground,shininess:3}));
  gnd.rotation.x=-Math.PI/2;gnd.position.set(0,0,ROAD_LEN/2);gnd.receiveShadow=true;scene.add(gnd);

  // Road with wet effect when raining
  const roadCol=weatherData.rain>0?new THREE.Color(T.road).multiplyScalar(.8):new THREE.Color(T.road);
  const road=new THREE.Mesh(new THREE.PlaneGeometry(FULL_W,ROAD_LEN),new THREE.MeshPhongMaterial({color:roadCol,shininess:weatherData.rain>0?80:26,specular:weatherData.rain>0?new THREE.Color(0x888888):new THREE.Color(0x222222)}));
  road.rotation.x=-Math.PI/2;road.position.set(0,.02,ROAD_LEN/2);road.receiveShadow=true;scene.add(road);

  // Lane markers
  const dashMat=new THREE.MeshPhongMaterial({color:0xFFFFFF,emissive:0xFFFFFF,emissiveIntensity:.1});
  const dLen=ROAD_LEN/80;
  for(let lane=1;lane<NUM_LANES;lane++){
    const lx=(lane/NUM_LANES)*FULL_W-ROAD_W;
    for(let seg=0;seg<80;seg++){
      const lz=seg*dLen+dLen/2;
      const dash=new THREE.Mesh(new THREE.PlaneGeometry(.2,dLen*.55),dashMat);
      dash.rotation.x=-Math.PI/2;dash.position.set(lx,.04,lz);scene.add(dash);
    }
  }
  const edgeMat=new THREE.MeshPhongMaterial({color:0xFFFFFF,emissive:0xFFFFFF,emissiveIntensity:.2});
  [-1,1].forEach(s=>{
    const e=new THREE.Mesh(new THREE.PlaneGeometry(.55,ROAD_LEN),edgeMat);
    e.rotation.x=-Math.PI/2;e.position.set(s*(ROAD_W-.28),.04,ROAD_LEN/2);scene.add(e);
  });
  const nK=90,kLen=ROAD_LEN/nK;
  for(let i=0;i<nK;i++){
    const kz=i*kLen+kLen/2;
    [-1,1].forEach(s=>{
      const km=new THREE.MeshPhongMaterial({color:i%2===0?0xFF2244:0xFFFFFF});
      const k=new THREE.Mesh(new THREE.BoxGeometry(1.8,.18,kLen),km);k.position.set(s*(ROAD_W+.9),.09,kz);scene.add(k);
    });
  }
  // Barriers
  const bMat=new THREE.MeshPhongMaterial({color:0xCCCCCC,shininess:22});
  const segW=8;const numSeg=Math.floor(ROAD_LEN/segW);
  [-1,1].forEach(s=>{
    const bar=new THREE.Mesh(new THREE.BoxGeometry(.72,.95,ROAD_LEN),bMat);
    bar.position.set(s*(ROAD_W+1.85),.48,ROAD_LEN/2);bar.castShadow=true;scene.add(bar);
    for(let i=0;i<numSeg;i++){
      const sm=new THREE.MeshPhongMaterial({color:i%2===0?0xFF4400:0xFFFFFF});
      const st=new THREE.Mesh(new THREE.BoxGeometry(.74,.98,.82),sm);
      st.position.set(s*(ROAD_W+1.85),.49,i*segW+4);scene.add(st);
    }
  });

  // Boost pads
  for(let bz=200;bz<ROAD_LEN-150;bz+=200){
    const lx=(Math.floor(Math.random()*NUM_LANES)+.5)*LANE_W-ROAD_W;
    const pMat=new THREE.MeshPhongMaterial({color:0x00FFC8,emissive:0x00AA88,emissiveIntensity:.85,transparent:true,opacity:.88});
    const pad=new THREE.Mesh(new THREE.PlaneGeometry(LANE_W*.88,5.5),pMat);
    pad.rotation.x=-Math.PI/2;pad.position.set(lx,.06,bz);scene.add(pad);
    const pl=new THREE.PointLight(0x00FFC8,.5,9);pl.position.set(lx,1,bz);scene.add(pl);
    // Arrows on boost pad
    for(let ai=0;ai<3;ai++){
      const arrowMat=new THREE.MeshPhongMaterial({color:0xFFFFFF,emissive:0xFFFFFF,emissiveIntensity:.6});
      const arrow=new THREE.Mesh(new THREE.BoxGeometry(.3,0.01,1.2),arrowMat);
      arrow.position.set(lx,0.07,bz-1+ai*1.2);scene.add(arrow);
    }
    boostPads.push({x:lx,z:bz,mesh:pad,light:pl});
  }

  // Pickups
  for(let pz=150;pz<ROAD_LEN-150;pz+=140){
    const lx=(Math.floor(Math.random()*NUM_LANES)+.5)*LANE_W-ROAD_W;
    const bg=new THREE.Group();
    const cube=new THREE.Mesh(new THREE.BoxGeometry(1.6,1.6,1.6),new THREE.MeshPhongMaterial({color:0xFFD700,emissive:0x886600,emissiveIntensity:.55,shininess:190}));
    bg.add(cube);
    const glow=new THREE.Mesh(new THREE.SphereGeometry(.58,8,8),new THREE.MeshPhongMaterial({color:0xFFFFFF,emissive:0xFFFFFF,emissiveIntensity:.9,transparent:true,opacity:.28}));
    bg.add(glow);
    const bpl=new THREE.PointLight(0xFFD700,.45,5.5);bg.add(bpl);
    bg.position.set(lx,1.75,pz);scene.add(bg);
    pickups.push({mesh:bg,x:lx,z:pz,active:true,respawnT:0});
  }

  // NEW: Coin pickups
  for(let cz=80;cz<ROAD_LEN-80;cz+=60){
    if(Math.random()<0.4){
      const lx=(Math.floor(Math.random()*NUM_LANES)+.5)*LANE_W-ROAD_W;
      const coinG=new THREE.Group();
      const coinM=new THREE.Mesh(new THREE.CylinderGeometry(.5,.5,.1,12),new THREE.MeshPhongMaterial({color:0xFFD700,emissive:0x886600,emissiveIntensity:.7,shininess:200}));
      coinM.rotation.x=Math.PI/2;coinG.add(coinM);
      const cl=new THREE.PointLight(0xFFD700,.3,4);coinG.add(cl);
      coinG.position.set(lx,1,cz);scene.add(coinG);
      pickups.push({mesh:coinG,x:lx,z:cz,active:true,respawnT:0,isCoin:true,value:5});
    }
  }

  buildFinishArch(ROAD_LEN-20);
  buildStartLine(10);
  buildScenery(T);
}

function buildFinishArch(fz){
  const fl=new THREE.Mesh(new THREE.PlaneGeometry(FULL_W,4),new THREE.MeshPhongMaterial({color:0xFFFFFF,emissive:0xFFFFFF,emissiveIntensity:.2}));
  fl.rotation.x=-Math.PI/2;fl.position.set(0,.05,fz);scene.add(fl);
  for(let c=0;c<8;c++)for(let r=0;r<2;r++)if((c+r)%2===0){
    const sq=new THREE.Mesh(new THREE.PlaneGeometry(FULL_W/8,1.9),new THREE.MeshPhongMaterial({color:0x000000}));
    sq.rotation.x=-Math.PI/2;sq.position.set((c/8)*FULL_W-ROAD_W+FULL_W/16,.06,fz);scene.add(sq);
  }
  const am=new THREE.MeshPhongMaterial({color:0xFF2244,emissive:0x880011,emissiveIntensity:.35});
  const pL=new THREE.Mesh(new THREE.BoxGeometry(.7,16,.7),am);pL.position.set(-ROAD_W-1.2,8,fz);scene.add(pL);
  const pR=pL.clone();pR.position.set(ROAD_W+1.2,8,fz);scene.add(pR);
  const arch=new THREE.Mesh(new THREE.BoxGeometry(FULL_W+2.4,.8,.7),am);arch.position.set(0,16,fz);scene.add(arch);
  const bn=new THREE.Mesh(new THREE.PlaneGeometry(FULL_W,2.6),new THREE.MeshPhongMaterial({color:0xFFD700,emissive:0x886600,emissiveIntensity:.65,side:THREE.DoubleSide}));
  bn.position.set(0,15,fz);scene.add(bn);
  const al1=new THREE.PointLight(0xFF2244,2.2,28);al1.position.set(-ROAD_W,14,fz);scene.add(al1);
  const al2=new THREE.PointLight(0xFF2244,2.2,28);al2.position.set(ROAD_W,14,fz);scene.add(al2);
  const al3=new THREE.PointLight(0xFFD700,2.5,35);al3.position.set(0,16,fz);scene.add(al3);
}
function buildStartLine(sz){
  const sl=new THREE.Mesh(new THREE.PlaneGeometry(FULL_W,3.5),new THREE.MeshPhongMaterial({color:0xFFFFFF,emissive:0xFFFFFF,emissiveIntensity:.18}));
  sl.rotation.x=-Math.PI/2;sl.position.set(0,.05,sz);scene.add(sl);
  for(let c=0;c<8;c++)for(let r=0;r<2;r++)if((c+r)%2===0){
    const sq=new THREE.Mesh(new THREE.PlaneGeometry(FULL_W/8,1.7),new THREE.MeshPhongMaterial({color:0x000000}));
    sq.rotation.x=-Math.PI/2;sq.position.set((c/8)*FULL_W-ROAD_W+FULL_W/16,.06,sz);scene.add(sq);
  }
}
function buildScenery(T){
  const sp=55;
  for(let z=0;z<=ROAD_LEN+sp;z+=sp){
    [-1,1].forEach(side=>{
      const x=side*(ROAD_W+10+Math.random()*25);
      let obj=null;
      switch(T.side){
        case 'beach':  obj=Math.random()<.55?mkPalm(x,0,z):mkUmbrella(x,0,z);break;
        case 'jungle': obj=mkJTree(x,0,z);break;
        case 'desert': obj=Math.random()<.5?mkCactus(x,0,z):mkRock(x,0,z);break;
        case 'arena':  obj=mkPillar(x,0,z);break;
      }
      if(obj){obj.castShadow=true;scene.add(obj);}
    });
  }
  // Spectators
  const cCols=[0xFF6688,0xFFAA44,0x44CCFF,0xAA44FF,0x44FF88,0xFF8844];
  for(let z=60;z<ROAD_LEN-60;z+=28){
    [-(ROAD_W+16),ROAD_W+16].forEach(x=>{
      const cg=new THREE.Group();
      const body=new THREE.Mesh(new THREE.CylinderGeometry(.28,.32,1.45,7),new THREE.MeshPhongMaterial({color:cCols[Math.floor(Math.random()*cCols.length)]}));
      body.position.y=.72;cg.add(body);
      const head=new THREE.Mesh(new THREE.SphereGeometry(.28,8,8),new THREE.MeshPhongMaterial({color:0xFFD0A0}));
      head.position.y=1.65;cg.add(head);
      const arm=new THREE.Mesh(new THREE.BoxGeometry(.12,.55,.12),new THREE.MeshPhongMaterial({color:0xFFD0A0}));
      arm.position.set(.38,1.5+Math.random()*.3,0);arm.rotation.z=-Math.PI/4+Math.random()*.25;cg.add(arm);
      // Animate spectators
      cg.userData.baseY=0;cg.userData.waveOffset=Math.random()*Math.PI*2;
      cg.position.set(x,0,z);scene.add(cg);
      fxList.push({type:'spectator',mesh:cg});
    });
  }
  // Beach ocean
  if(T.side==='beach'){
    const oc=new THREE.Mesh(new THREE.PlaneGeometry(120,ROAD_LEN+200),new THREE.MeshPhongMaterial({color:0x0088BB,transparent:true,opacity:.7,shininess:200,specular:0x88CCFF}));
    oc.rotation.x=-Math.PI/2;oc.position.set(-(ROAD_W+80),-.5,ROAD_LEN/2);scene.add(oc);
    // Clouds
    for(let i=0;i<14;i++){
      const cg=new THREE.Group();
      for(let j=0;j<5;j++){
        const puff=new THREE.Mesh(new THREE.SphereGeometry(3.5+Math.random()*2.5,8,8),new THREE.MeshPhongMaterial({color:0xF8F8FF,transparent:true,opacity:.88}));
        puff.position.set(j*3.5,Math.random()*2,Math.random()*2);cg.add(puff);
      }
      cg.position.set((Math.random()-.5)*80,55+Math.random()*30,Math.random()*ROAD_LEN);
      cg.userData.vx=(Math.random()<.5?1:-1)*(3+Math.random()*3);
      fxList.push({type:'cloud',mesh:cg});scene.add(cg);
    }
    // Hot air balloon
    const bal=new THREE.Group();
    const env=new THREE.Mesh(new THREE.SphereGeometry(9.5,12,12),new THREE.MeshPhongMaterial({color:0xFF8800}));
    env.position.y=18;bal.add(env);
    for(let i=0;i<6;i++){const s=new THREE.Mesh(new THREE.CylinderGeometry(9.55,9.55,3,7),new THREE.MeshPhongMaterial({color:i%2===0?0xFF2244:0xFFFFFF,transparent:true,opacity:.78}));s.position.y=15+i*1.8;bal.add(s);}
    const bsk=new THREE.Mesh(new THREE.BoxGeometry(3.8,2.5,3.8),new THREE.MeshPhongMaterial({color:0x8B5A00}));bsk.position.y=4;bal.add(bsk);
    bal.position.set(-ROAD_W-55,58,ROAD_LEN*.55);
    fxList.push({type:'balloon',mesh:bal});scene.add(bal);
  }
  if(T.side==='arena'){
    for(let z=80;z<ROAD_LEN;z+=180){
      [-(ROAD_W+5),ROAD_W+5].forEach(x=>{
        const pole=new THREE.Mesh(new THREE.CylinderGeometry(.3,.3,20,7),new THREE.MeshPhongMaterial({color:0x222244}));
        pole.position.set(x,10,z);scene.add(pole);
        const lgt=new THREE.PointLight(0x4466FF,1.8,55);lgt.position.set(x,20,z);scene.add(lgt);
      });
    }
  }
}

function mkPalm(x,y,z){const g=new THREE.Group();const h=5+Math.random()*3.5;const tr=new THREE.Mesh(new THREE.CylinderGeometry(.12,.28,h,9),new THREE.MeshPhongMaterial({color:0x7B5A14}));tr.position.y=h/2;tr.rotation.z=(Math.random()-.5)*.28;g.add(tr);for(let i=0;i<7;i++){const fa=(i/7)*Math.PI*2;const fr=new THREE.Mesh(new THREE.BoxGeometry(.1,2.8,.34),new THREE.MeshPhongMaterial({color:0x2A9200}));fr.position.set(Math.cos(fa)*1.25,h,Math.sin(fa)*1.25);fr.rotation.set(-.5,fa,.3);g.add(fr);}for(let i=0;i<3;i++){const co=new THREE.Mesh(new THREE.SphereGeometry(.22,7,7),new THREE.MeshPhongMaterial({color:0x7B5A14}));co.position.set(Math.cos(i/3*Math.PI*2)*.5,h-.28,Math.sin(i/3*Math.PI*2)*.5);g.add(co);}g.position.set(x,y,z);return g;}
function mkUmbrella(x,y,z){const g=new THREE.Group();const pole=new THREE.Mesh(new THREE.CylinderGeometry(.06,.06,2.4,7),new THREE.MeshPhongMaterial({color:0xCCCCCC}));pole.position.y=1.2;g.add(pole);const cols=[0xFF2244,0xFFD700,0x0099FF,0x22CC44,0xFF8800];const top=new THREE.Mesh(new THREE.ConeGeometry(1.6,.55,9),new THREE.MeshPhongMaterial({color:cols[Math.floor(Math.random()*cols.length)]}));top.position.y=2.15;g.add(top);g.position.set(x,y,z);return g;}
function mkJTree(x,y,z){const g=new THREE.Group();const h=7+Math.random()*4;const tr=new THREE.Mesh(new THREE.CylinderGeometry(.2,.38,h,9),new THREE.MeshPhongMaterial({color:0x3D2200}));tr.position.y=h/2;g.add(tr);for(let l=0;l<3;l++){const fo=new THREE.Mesh(new THREE.ConeGeometry(2.6-l*.42,3,10),new THREE.MeshPhongMaterial({color:new THREE.Color().setHSL(.3,.72,.22+l*.04)}));fo.position.y=h*.45+l*1.6;g.add(fo);}g.position.set(x,y,z);return g;}
function mkCactus(x,y,z){const g=new THREE.Group();const mat=new THREE.MeshPhongMaterial({color:0x2D7A2D});const h=3.5+Math.random()*2;const b=new THREE.Mesh(new THREE.CylinderGeometry(.22,.28,h,9),mat);b.position.y=h/2;g.add(b);const a1=new THREE.Mesh(new THREE.CylinderGeometry(.13,.13,1.7,7),mat);a1.rotation.z=Math.PI/2;a1.position.set(.75,h*.6,0);g.add(a1);const a2=new THREE.Mesh(new THREE.CylinderGeometry(.11,.11,1.3,7),mat);a2.rotation.z=-Math.PI/2;a2.position.set(-.65,h*.75,0);g.add(a2);g.position.set(x,y,z);return g;}
function mkRock(x,y,z){const g=new THREE.Group();const s=1.2+Math.random()*2;const r=new THREE.Mesh(new THREE.BoxGeometry(s*1.7,.9*s,s*1.2),new THREE.MeshPhongMaterial({color:0xA08040,shininess:3}));r.rotation.y=Math.random()*Math.PI;r.position.y=s*.45;g.add(r);g.position.set(x,y,z);return g;}
function mkPillar(x,y,z){const g=new THREE.Group();const p=new THREE.Mesh(new THREE.CylinderGeometry(.6,.95,12,9),new THREE.MeshPhongMaterial({color:0x1A1A3A,shininess:65}));p.position.y=6;g.add(p);const ring=new THREE.Mesh(new THREE.TorusGeometry(1.2,.15,9,20),new THREE.MeshPhongMaterial({color:0x4466FF,emissive:0x2244CC,emissiveIntensity:1.2}));ring.position.y=12.3;g.add(ring);g.position.set(x,y,z);return g;}

// â”€â”€ RACER CLASS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Racer{
  constructor(cidx,isP,startZ,lane,name){
    this.cidx=cidx;this.def=CARS[cidx];this.isP=isP;this.name=name||this.def.name;
    this.z=startZ;
    this.x=(lane+.5)*LANE_W-ROAD_W;
    this.targetX=this.x;
    this.vz=0;this.vx=0;

    this.lap=1;this.rPos=1;this.finished=false;this.finishTime=0;
    this.lapTimes=[];this.currentLapStart=0;

    const up=isP?SD.upgrades:{engine:0,handling:0,armor:0,boost:0};
    this.maxSpd=(this.def.spd+up.engine)*1.6+10;
    this.accRate=(this.def.acc+up.engine)*0.22;
    this.hdl=(this.def.hdl+up.handling)*0.30;
    this.driftF=(this.def.drift+up.handling)*0.07;
    this.armor=(this.def.arm+up.armor)*10+25;this.maxArmor=this.armor;
    this.boostE=100;this.maxBoost=(this.def.bst+up.boost)*10;

    this.item=null;
    this.shield=false;this.shieldT=0;
    this.inv=false;this.invT=0;
    this.slowed=false;this.slowT=0;
    this.frozen=false;this.frozenT=0;
    this.magnetT=0;this.aiItemCD=0;
    this.isBoosting=false;

    this.leanAngle=0;this.steerAngle=0;this.visualYaw=0;
    this.drifting=false;this.driftAngle=0;this.driftCharge=0;

    // NEW: Drift combo system
    this.driftCombo=0;this.comboTimer=0;this.comboMult=1;
    this.totalDriftDist=0;

    // NEW: Trick system
    this.trickT=0;this.inAir=false;this.airTime=0;
    this.boostCount=0;

    // NEW: Wrong way detection
    this.prevZ=startZ;
    this.wrongWayTimer=0;

    // AI state
    this.aiTimer=0;this.aiLaneTimer=0;
    this.personality={aggression:Math.random()*.7+.45,bravery:Math.random()*.8+.3,driftSkill:Math.random()*.7+.3,skill:Math.random()*.5+.5};

    this.mesh=buildCarMesh(this.def);
    this._shield();this._shadow();this._skidTrails();
    this.mesh.position.set(this.x,.6,this.z);
    this.mesh.rotation.y=0;
    scene.add(this.mesh);
  }

  _shield(){
    const mat=new THREE.MeshPhongMaterial({color:0x00FFC8,transparent:true,opacity:.2,side:THREE.DoubleSide});
    this.shieldMesh=new THREE.Mesh(new THREE.SphereGeometry(2.9,12,9),mat);
    this.shieldMesh.visible=false;
    const ring=new THREE.Mesh(new THREE.TorusGeometry(2.9,.07,9,32),new THREE.MeshPhongMaterial({color:0x00FFC8,emissive:0x00FFC8,emissiveIntensity:.9}));
    this.shieldMesh.add(ring);
    this.mesh.add(this.shieldMesh);
  }
  _shadow(){
    this.shadowMesh=new THREE.Mesh(new THREE.CircleGeometry(1.4,16),new THREE.MeshBasicMaterial({color:0x000000,transparent:true,opacity:.28}));
    this.shadowMesh.rotation.x=-Math.PI/2;scene.add(this.shadowMesh);
  }
  _skidTrails(){
    // NEW: Skid mark geometry for drift effect
    this.skidPoints=[];this.skidLines=[];
  }

  syncMesh(){
    this.mesh.position.set(this.x,.6,this.z);
    this.mesh.rotation.z=this.leanAngle;
    this.mesh.rotation.y=this.visualYaw;
    this.shadowMesh.position.set(this.x,.025,this.z);
    if(this.shieldMesh.visible)this.shieldMesh.rotation.y+=.035;
    const ws=this.mesh.userData.wheels;
    if(ws){
      const rollDelta=this.vz*0.055;
      ws.forEach(w=>{w.children[0].rotation.x+=rollDelta;w.children[1].rotation.x+=rollDelta;});
      const sa=this.steerAngle*.65;
      [ws[0],ws[1]].forEach(w=>{if(w)w.rotation.y=sa;});
    }
  }

  update(dt,inp){
    if(this.finished){this.syncMesh();return;}

    // Status timers
    if(this.shieldT>0){this.shieldT-=dt;if(this.shieldT<=0){this.shield=false;this.shieldMesh.visible=false;}}
    if(this.invT>0){this.invT-=dt;if(this.invT<=0)this.inv=false;}
    if(this.slowT>0){this.slowT-=dt;if(this.slowT<=0)this.slowed=false;}
    if(this.frozenT>0){this.frozenT-=dt;if(this.frozenT<=0)this.frozen=false;}
    if(this.magnetT>0)this.magnetT-=dt;
    if(this.aiItemCD>0)this.aiItemCD-=dt;
    if(this.frozen){this.syncMesh();return;}

    const sM=this.slowed?0.35:1;
    const onRoad=this.x>-ROAD_W&&this.x<ROAD_W;
    const offRoadFactor=onRoad?1:0.60;
    const gripMod=weatherData.gripMod*(onRoad?1:0.8);

    if(!onRoad&&this.isP){
      document.getElementById('offroadWarn').style.opacity='1';offroadTimer=0.3;
    }

    // NEW: Wrong way detection
    if(this.isP){
      const dzActual=this.z-this.prevZ;
      if(dzActual<-2&&this.vz<-0.5){
        this.wrongWayTimer+=dt;
        document.getElementById('wrongWay').style.opacity=this.wrongWayTimer>0.5?'1':'0';
      } else {
        this.wrongWayTimer=0;document.getElementById('wrongWay').style.opacity='0';
      }
      this.prevZ=this.z;
    }

    if(this.isP){
      this._updatePlayer(dt,inp,sM,onRoad,offRoadFactor,gripMod);
    } else {
      this._updateAI(dt,sM,onRoad,offRoadFactor);
    }

    // Move
    this.z+=this.vz*dt;
    this.x+=this.vx*dt;

    // Soft wall bounce
    const xLimit=ROAD_W+1.8;
    if(this.x<-xLimit){this.x=-xLimit;this.vx=Math.abs(this.vx)*0.35;}
    if(this.x> xLimit){this.x= xLimit;this.vx=-Math.abs(this.vx)*0.35;}

    // Car-car collision
    racers.forEach(r=>{
      if(r===this||r.finished)return;
      const dz=r.z-this.z,dx=r.x-this.x;
      const dist=Math.sqrt(dx*dx+dz*dz);
      if(dist<3.8&&dist>0.01){
        const push=(3.8-dist)/3.8*0.6;
        const nx=dx/dist,nz=dz/dist;
        this.x-=nx*push*0.8;r.x+=nx*push*0.8;
        const relVz=this.vz-r.vz;
        if(relVz>0){const impulse=relVz*0.18;this.vz-=impulse;r.vz+=impulse*0.5;}
        if(this.isP&&dist<3.2){shakeAmt=0.25;this.takeDmg(3);if(!raceStats.noHit){}else{raceStats.noHit=false;}}
      }
    });

    // Boost pads
    boostPads.forEach(bp=>{
      if(Math.abs(this.z-bp.z)<4.5&&Math.abs(this.x-bp.x)<LANE_W*.7){
        this.vz=Math.min(this.maxSpd*2.2,this.vz+10);
        if(this.isP){showNotif('âš¡ BOOST PAD!','#00FFC8');sfx.boost();raceStats.boostCount++;}
      }
    });

    // Pickups
    pickups.forEach(pk=>{
      if(!pk.active)return;
      if(Math.abs(this.z-pk.z)<3.2&&Math.abs(this.x-pk.x)<3.2){
        if(pk.isCoin){
          // Coin pickup
          const val=pk.value||5;
          if(this.isP){
            SD.coins+=val;coinsEarned+=val;raceStats.raceCoins+=val;
            document.getElementById('hudCoins').textContent=SD.coins;
            sfx.coin();
            spawnDmgFloat(this.mesh.position,val,'coin');
          }
          pk.active=false;pk.mesh.visible=false;pk.respawnT=8;
        } else if(!this.item){
          const pu=POWERUPS[Math.floor(Math.random()*POWERUPS.length)];
          this.item=pu;
          if(this.isP){document.getElementById('itemEmoji').textContent=pu.e;document.getElementById('itemLabel').textContent=pu.name;sfx.pickup();showNotif(pu.e+' '+pu.name+'!','#FFD700');}
          pk.active=false;pk.mesh.visible=false;pk.respawnT=10;
        }
      }
    });

    // Banana & oil slick checks
    for(let i=bananas.length-1;i>=0;i--){
      const bn=bananas[i];if(bn.owner===this)continue;
      if(Math.abs(this.z-bn.z)<2.8&&Math.abs(this.x-bn.x)<2.8){
        this.slowed=true;this.slowT=2.5;this.vz*=0.38;
        scene.remove(bn.mesh);bananas.splice(i,1);
        if(!raceStats.noHit){}else raceStats.noHit=false;
        sfx.hit();if(this.isP){showNotif('ğŸŒ SLIPPED!','#FFD700');flashDmg();}
      }
    }
    for(let i=oilSlicks.length-1;i>=0;i--){
      const os=oilSlicks[i];if(os.owner===this)continue;
      if(Math.abs(this.z-os.z)<3.5&&Math.abs(this.x-os.x)<3.5){
        this.driftAngle+=(Math.random()-.5)*0.8;
        this.vx+=(Math.random()-.5)*12;
        this.slowed=true;this.slowT=1.5;
        sfx.hit();if(this.isP){showNotif('ğŸ›¢ï¸ OIL SLICK!','#888888');flashDmg();}
      }
    }

    // Magnet
    if(this.isP&&this.magnetT>0){const e=Math.floor(dt*6);SD.coins+=e;coinsEarned+=e;raceStats.raceCoins+=e;document.getElementById('hudCoins').textContent=SD.coins;}

    // NEW: Drift distance tracking
    if(this.isP&&this.drifting){
      const dd=Math.abs(this.vz)*dt;
      this.totalDriftDist+=dd;
      raceStats.driftDist+=dd;
    }

    // Lap / finish logic
    if(!this.finished&&this.z>=ROAD_LEN){
      if(this.lap<LAP_TOTAL){
        // Record lap time
        if(this.isP){
          const lapT=raceTime-this.currentLapStart;
          this.lapTimes.push(lapT);
          if(lapT<bestLapTime){
            bestLapTime=lapT;
            const mm=Math.floor(lapT/60),ss=(lapT%60).toFixed(2);
            document.getElementById('bestLapBadge').textContent='ğŸ… BEST LAP: '+mm+':'+ss.toString().padStart(5,'0');
            document.getElementById('bestLapBadge').style.opacity='1';
            setTimeout(()=>document.getElementById('bestLapBadge').style.opacity='0',3000);
          }
          this.currentLapStart=raceTime;
        }
        this.lap++;this.z=8;
        if(this.isP){updateLapUI();sfx.lap();showNotif('ğŸ”„ LAP '+this.lap+(this.lap===LAP_TOTAL?' â€” FINAL!':''),'#FFD700');document.getElementById('lapFlash').style.opacity='.9';setTimeout(()=>document.getElementById('lapFlash').style.opacity='0',360);}
      } else {
        this.finished=true;this.finishTime=raceTime;
        if(this.isP)onPlayerFinish();
      }
    }

    this.syncMesh();
  }

  // â”€â”€ PLAYER PHYSICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _updatePlayer(dt,inp,sM,onRoad,offFactor,gripMod){
    const steerDir=inp.l?-1:(inp.r?1:0);
    const speedRatio=Math.min(1,this.vz/Math.max(1,this.maxSpd));

    // Forward speed
    let fwdTarget;
    if(inp.f){
      fwdTarget=this.maxSpd*sM*offFactor*weatherData.speedMod*(this.isBoosting?1.72:1);
    } else if(inp.b){
      fwdTarget=this.vz>0.5?0:-this.maxSpd*0.25*sM;
    } else {
      fwdTarget=0;
    }
    const accLerp=inp.f?0.030:inp.b?(this.vz>0?0.045:0.025):0.020;
    this.vz+=(fwdTarget-this.vz)*Math.min(1,accLerp*dt*60);
    if(!inp.f&&!inp.b)this.vz*=Math.pow(0.982,dt*60);
    if(Math.abs(this.vz)<0.04&&!inp.f&&!inp.b)this.vz=0;

    // Lateral / steering
    const steerStrength=this.hdl*(15+speedRatio*2)*offFactor*sM*gripMod;
    const steerTargetVx=steerDir*steerStrength;
    const steerLerp=steerDir!==0?0.12:0.08;
    this.vx+=(steerTargetVx-this.vx)*Math.min(1,steerLerp*dt*60);
    const latFriction=onRoad?(steerDir!==0?0.88:0.84):0.92;
    this.vx*=Math.pow(latFriction*gripMod,dt*60);
    const maxLat=this.hdl*16;
    this.vx=Math.max(-maxLat,Math.min(maxLat,this.vx));

    // Drift
    const isDrifting=Math.abs(steerDir)>0.5&&this.vz>this.maxSpd*0.35&&onRoad;
    if(isDrifting){
      const driftTarget=steerDir*0.14*this.driftF;
      this.driftAngle+=(driftTarget-this.driftAngle)*Math.min(1,dt*5);
      this.vx+=this.driftAngle*this.vz*dt*0.7;
      if(Math.abs(this.driftAngle)>0.05){
        this.driftCharge=Math.min(MAX_DRIFT,this.driftCharge+dt*14*this.driftF);
        // Drift combo
        this.comboTimer=1.5;
      }
      if(!this.drifting){this.drifting=true;sfx.drift();}
      // Spawn smoke
      if(Math.random()<0.15*dt*60){spawnSmoke(this.x,this.z);}
    } else {
      this.driftAngle*=Math.pow(0.05,dt);
      if(this.drifting&&this.driftCharge>=MAX_DRIFT*0.4){
        this.driftCombo++;
        if(this.driftCombo>raceStats.maxCombo)raceStats.maxCombo=this.driftCombo;
        const bonus=Math.round(this.driftCharge*0.12*(1+this.driftCombo*0.2));
        this.boostE=Math.min(this.maxBoost,this.boostE+bonus);
        showNotif('âš¡ DRIFT x'+this.driftCombo+'! +'+bonus,'#FF8800');
        updateComboHUD();
        this.driftCharge=0;
      }
      if(this.drifting)this.drifting=false;
    }
    // Combo timer decay
    if(this.comboTimer>0){
      this.comboTimer-=dt;
    } else if(this.driftCombo>0){
      this.driftCombo=0;updateComboHUD();
    }

    // BOOST
    if(inp.boost&&this.boostE>0&&onRoad){
      if(!this.isBoosting){this.boostCount++;raceStats.boostCount++;}
      this.isBoosting=true;
      this.vz=Math.min(this.maxSpd*1.72*sM,this.vz+(this.maxSpd*1.72-this.vz)*Math.min(1,0.06*dt*60));
      this.boostE=Math.max(0,this.boostE-dt*20);
      if(Math.random()<0.1)sfx.boost();
      document.getElementById('boostFlash').style.opacity='.85';
      document.getElementById('speedLines').style.opacity='.70';
    } else {
      this.isBoosting=false;
      if(this.boostE<this.maxBoost)this.boostE+=dt*7;
      document.getElementById('boostFlash').style.opacity='0';
      const lineOp=Math.max(0,(this.vz/this.maxSpd-0.55))*0.5;
      document.getElementById('speedLines').style.opacity=lineOp.toString();
    }

    // Smooth visuals
    const leanTarget=steerDir*-speedRatio*0.25;
    this.leanAngle+=(leanTarget-this.leanAngle)*Math.min(1,dt*8);
    const steerVisTarget=steerDir*0.55+this.driftAngle*0.4;
    this.steerAngle+=(steerVisTarget-this.steerAngle)*Math.min(1,dt*10);
    const yawTarget=this.driftAngle*0.28;
    this.visualYaw+=(yawTarget-this.visualYaw)*Math.min(1,dt*7);

    // Drift HUD
    const dEl=document.getElementById('driftHUD');
    const dBar=document.getElementById('driftBar');
    if(this.drifting&&Math.abs(this.driftAngle)>0.03){
      dEl.style.opacity='1';dBar.style.width=(this.driftCharge/MAX_DRIFT*100)+'%';
    } else {
      dEl.style.opacity='0';
    }
  }

  // â”€â”€ AI PHYSICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _updateAI(dt,sM,onRoad,offFactor){
    const diff=SD.settings.difficulty;
    const dM=diff==='easy'?0.62:diff==='hard'?1.28:1.0;
    const skill=this.personality.skill;

    let rubberFactor=1.0;
    if(playerR){
      const gap=playerR.z-this.z+(playerR.lap-this.lap)*ROAD_LEN;
      if(gap>120)      rubberFactor=0.82+0.12*(1-skill);
      else if(gap<-120)rubberFactor=1.15+0.08*skill;
      else             rubberFactor=0.96+0.06*skill;
    }
    const tgtSpd=this.maxSpd*dM*rubberFactor*sM*offFactor*weatherData.speedMod;
    const aiAccLerp=0.022*(1+skill*0.8);
    this.vz+=(tgtSpd-this.vz)*Math.min(1,aiAccLerp*dt*60);

    if(this.boostE<this.maxBoost)this.boostE+=dt*6;
    const playerAhead=playerR&&(playerR.z-this.z+(playerR.lap-this.lap)*ROAD_LEN)>0;
    const boostChance=playerAhead?0.007*skill*dM:0.003;
    if(this.boostE>40&&Math.random()<boostChance){this.vz=Math.min(this.maxSpd*1.6,this.vz+5);this.boostE-=20;}

    this.aiLaneTimer-=dt;
    if(this.aiLaneTimer<=0){this.aiLaneTimer=1.2+Math.random()*2.0*(2-skill);this._aiChooseLane();}

    const dxTarget=this.targetX-this.x;
    const latSpd=Math.min(Math.abs(dxTarget)*2.5,6+skill*4);
    const tgtVx=Math.sign(dxTarget)*Math.min(latSpd,Math.abs(dxTarget)*3);
    this.vx+=(tgtVx-this.vx)*Math.min(1,dt*6*(0.7+skill*0.5));
    this.vx*=Math.pow(0.80,dt*60);

    const leanTarget=this.vx>0?0.18:this.vx<0?-0.18:0;
    this.leanAngle+=(leanTarget-this.leanAngle)*Math.min(1,dt*6);
    this.steerAngle+=(Math.sign(this.vx)*0.4-this.steerAngle)*Math.min(1,dt*8);
    const yawTarget=this.vx*0.008;
    this.visualYaw+=(yawTarget-this.visualYaw)*Math.min(1,dt*6);

    if(this.item&&this.aiItemCD<=0){
      const useChance=0.006*(0.5+this.personality.aggression)*dM;
      if(Math.random()<useChance){this.fireItem();this.aiItemCD=4+Math.random()*4;}
    }
  }

  _aiChooseLane(){
    const skill=this.personality.skill;
    const ahead=racers.find(r=>{
      if(r===this||r.finished)return false;
      const dz=r.z-this.z;
      return dz>0&&dz<35&&Math.abs(r.x-this.x)<LANE_W*1.4;
    });
    if(ahead){
      const leftX=this.x-LANE_W,rightX=this.x+LANE_W;
      const leftClear=leftX>-ROAD_W&&!racers.some(r=>r!==this&&Math.abs(r.z-this.z)<20&&Math.abs(r.x-leftX)<LANE_W*0.8);
      const rightClear=rightX<ROAD_W&&!racers.some(r=>r!==this&&Math.abs(r.z-this.z)<20&&Math.abs(r.x-rightX)<LANE_W*0.8);
      if(leftClear&&rightClear)this.targetX=Math.random()<0.5?leftX:rightX;
      else if(leftClear)this.targetX=leftX;
      else if(rightClear)this.targetX=rightX;
      this.targetX=Math.max(-ROAD_W+LANE_W*0.5,Math.min(ROAD_W-LANE_W*0.5,this.targetX));
    } else {
      if(Math.random()<0.28+skill*0.2){
        const newLane=Math.floor(Math.random()*NUM_LANES);
        const newX=(newLane+0.5)*LANE_W-ROAD_W;
        if(Math.random()<skill*0.4){
          const nearby=boostPads.find(bp=>bp.z>this.z&&bp.z-this.z<200);
          if(nearby)this.targetX=nearby.x;else this.targetX=newX;
        } else this.targetX=newX;
      }
    }
  }

  takeDmg(amt){
    if(this.shield||this.inv)return;
    this.armor=Math.max(0,this.armor-amt);
    if(this.isP){sfx.hit();updateHpBar();shakeAmt=0.6;flashDmg();spawnDmgFloat(this.mesh.position,amt,'hit');raceStats.noHit=false;}
    if(this.armor<=0){this.armor=this.maxArmor*0.35;this.vz*=0.2;this.slowed=true;this.slowT=2.0;sfx.explode();}
  }

  fireItem(){
    if(!this.item)return;
    const it=this.item;this.item=null;
    if(this.isP){document.getElementById('itemEmoji').textContent='â“';document.getElementById('itemLabel').textContent='NO ITEM';}
    switch(it.id){
      case 'fireball':spawnProj(this,'fire');break;
      case 'homing':spawnProj(this,'homing');break;
      case 'triple':spawnProj(this,'fire');setTimeout(()=>spawnProj(this,'fire'),150);setTimeout(()=>spawnProj(this,'fire'),300);break;
      case 'thunder':
        racers.forEach(r=>{if(r===this||r.inv)return;if(Math.abs(r.z-this.z)<30&&Math.abs(r.x-this.x)<FULL_W*0.8)r.takeDmg(24);});
        sfx.explode();if(this.isP){showNotif('âš¡ THUNDER!','#FFFF00');shakeAmt=0.5;}
        const tl=new THREE.PointLight(0xFFFF00,7,55);tl.position.set(this.x,5,this.z);scene.add(tl);
        setTimeout(()=>scene.remove(tl),500);break;
      case 'banana':
        const bm=new THREE.Mesh(new THREE.SphereGeometry(.44,8,8),new THREE.MeshPhongMaterial({color:0xFFD700,emissive:0x886600,emissiveIntensity:.55}));
        bm.position.set(this.x,.4,this.z-5);scene.add(bm);
        bananas.push({mesh:bm,x:this.x,z:this.z-5,owner:this});
        if(this.isP)showNotif('ğŸŒ BANANA DROP!','#FFD700');break;
      case 'oil':
        // NEW: Oil slick â€” bigger slip zone
        const om=new THREE.Mesh(new THREE.CircleGeometry(3.5,12),new THREE.MeshPhongMaterial({color:0x222222,shininess:200,specular:new THREE.Color(0x555555),transparent:true,opacity:.7}));
        om.rotation.x=-Math.PI/2;om.position.set(this.x,.03,this.z-6);scene.add(om);
        oilSlicks.push({mesh:om,x:this.x,z:this.z-6,owner:this,life:20});
        if(this.isP)showNotif('ğŸ›¢ï¸ OIL DOWN!','#888888');break;
      case 'swap':
        // NEW: Swap positions with nearest racer
        let nearest=null,nearDist=9999;
        racers.forEach(r=>{if(r===this)return;const d=Math.abs(r.z-this.z);if(d<nearDist){nearDist=d;nearest=r;}});
        if(nearest){
          const tx=nearest.x,tz=nearest.z;
          nearest.x=this.x;nearest.z=this.z;
          this.x=tx;this.z=tz;
          sfx.explode();if(this.isP)showNotif('ğŸŒ€ POSITION SWAP!','#AA00FF');}
        break;
      case 'shield':this.shield=true;this.shieldT=10;this.shieldMesh.visible=true;if(this.isP)showNotif('ğŸ›¡ï¸ SHIELD!','#00FFC8');break;
      case 'repair':
        this.armor=Math.min(this.maxArmor,this.armor+42);
        if(this.isP){updateHpBar();showNotif('ğŸ’Š REPAIRED +42!','#00FFC8');spawnDmgFloat(this.mesh.position,42,'heal');flashHeal();}break;
      case 'nitro':this.vz=this.maxSpd*2.1;setTimeout(()=>{if(this.vz>this.maxSpd)this.vz=this.maxSpd;},3200);if(this.isP)showNotif('ğŸš€ NITRO!','#00FFC8');sfx.boost();break;
      case 'freeze':racers.forEach(r=>{if(r===this)return;r.frozen=true;r.frozenT=2.5;});sfx.explode();if(this.isP)showNotif('â„ï¸ FREEZE ALL!','#88CCFF');break;
      case 'magnet':this.magnetT=7;if(this.isP)showNotif('ğŸ§² COIN MAGNET!','#FFD700');break;
    }
    if(this.isP)sfx.pickup();
  }
}

// â”€â”€ Projectiles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnProj(owner,type){
  const col=type==='homing'?0x00FFC8:0xFF4400;
  const mesh=new THREE.Mesh(new THREE.SphereGeometry(.46,9,9),new THREE.MeshPhongMaterial({color:col,emissive:col,emissiveIntensity:.9}));
  mesh.position.set(owner.x,.9,owner.z+5);
  const pl=new THREE.PointLight(col,1.1,10);mesh.add(pl);
  scene.add(mesh);
  projectiles.push({mesh,x:owner.x,z:owner.z+5,vz:45,vx:0,owner,type,life:4.5});
  tone(500,.15,'sawtooth',.25,.3);
}

function updateProjectiles(dt){
  for(let i=projectiles.length-1;i>=0;i--){
    const p=projectiles[i];p.life-=dt;
    if(p.life<=0){scene.remove(p.mesh);projectiles.splice(i,1);continue;}
    if(p.type==='homing'){
      let cl=null,cd=9999;
      racers.forEach(r=>{if(r===p.owner)return;const d=Math.abs(r.z-p.z)+Math.abs(r.x-p.x);if(d<cd){cd=d;cl=r;}});
      if(cl)p.vx+=(cl.x-p.x)*dt*10;
    }
    p.z+=p.vz*dt;p.x+=p.vx*dt;
    p.mesh.position.set(p.x,.9,p.z);p.mesh.rotation.y+=dt*9;
    for(let j=racers.length-1;j>=0;j--){
      const r=racers[j];
      if(r===p.owner||r.inv)continue;
      if(Math.abs(r.z-p.z)<3&&Math.abs(r.x-p.x)<2.5){
        r.takeDmg(p.type==='homing'?30:24);sfx.explode();
        const ex=new THREE.Mesh(new THREE.SphereGeometry(.5,8,8),new THREE.MeshBasicMaterial({color:0xFF8800,transparent:true,opacity:.9}));
        ex.position.set(p.x,.9,p.z);scene.add(ex);
        const ep=new THREE.PointLight(0xFF4400,4,20);ep.position.set(p.x,.9,p.z);scene.add(ep);
        fxList.push({type:'explode',mesh:ex,light:ep,life:1,maxLife:1});
        scene.remove(p.mesh);projectiles.splice(i,1);break;
      }
    }
  }
}

// NEW: Smoke particle spawn
function spawnSmoke(x,z){
  const pos=new THREE.Vector3(x,0.3,z).project(camera);
  const sx=((pos.x+1)/2)*innerWidth,sy=((1-pos.y)/2)*innerHeight;
  if(sx<-50||sx>innerWidth+50||sy<-50||sy>innerHeight+50)return;
  const el=document.createElement('div');
  el.className='smoke';el.style.left=(sx-8)+'px';el.style.top=(sy-8)+'px';
  el.style.width='16px';el.style.height='16px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1000);
}

function updateFX(dt){
  pickups.forEach(pk=>{
    if(pk.active){
      if(pk.isCoin){pk.mesh.rotation.y+=dt*3.5;pk.mesh.position.y=1+Math.abs(Math.sin(Date.now()*.004))*.2;}
      else{pk.mesh.rotation.y+=dt*2.2;pk.mesh.position.y=1.75+Math.abs(Math.sin(Date.now()*.0022))*.34;}
    } else {pk.respawnT-=dt;if(pk.respawnT<=0){pk.active=true;pk.mesh.visible=true;}}
  });
  boostPads.forEach(bp=>{bp.mesh.material.emissiveIntensity=0.55+Math.sin(Date.now()*.006)*0.35;});

  // Oil slick lifetime
  for(let i=oilSlicks.length-1;i>=0;i--){
    oilSlicks[i].life-=dt;
    if(oilSlicks[i].life<=0){scene.remove(oilSlicks[i].mesh);oilSlicks.splice(i,1);}
  }

  for(let i=fxList.length-1;i>=0;i--){
    const fx=fxList[i];
    if(fx.type==='explode'){
      fx.life-=dt;const t=fx.life/fx.maxLife;
      fx.mesh.scale.setScalar(1+(1-t)*5);fx.mesh.material.opacity=t*.9;fx.light.intensity=t*4;
      if(fx.life<=0){scene.remove(fx.mesh);scene.remove(fx.light);fxList.splice(i,1);}
    } else if(fx.type==='cloud'){
      fx.mesh.position.x+=fx.mesh.userData.vx*dt;
      if(fx.mesh.position.x<-120)fx.mesh.position.x=120;
      if(fx.mesh.position.x>120)fx.mesh.position.x=-120;
    } else if(fx.type==='balloon'){
      fx.mesh.position.y=58+Math.sin(Date.now()*.0004)*4;
      fx.mesh.rotation.y+=dt*.035;
    } else if(fx.type==='spectator'){
      // Wave animation based on player proximity
      if(playerR){
        const dist=Math.abs(fx.mesh.position.z-playerR.z);
        if(dist<40){
          const wave=Math.sin(Date.now()*.006+fx.mesh.userData.waveOffset)*0.3;
          fx.mesh.children[2]&&(fx.mesh.children[2].rotation.z=-Math.PI/4+wave);
        }
      }
    }
  }
  if(offroadTimer>0){offroadTimer-=dt;if(offroadTimer<=0)document.getElementById('offroadWarn').style.opacity='0';}
}

// â”€â”€ CAMERA â€” multiple modes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const camState={x:0,y:9,z:-18,lx:0,ly:1.5,lz:30,fov:65};

function updateCamera(dt){
  if(!playerR)return;
  const px=playerR.x,pz=playerR.z;
  const speedR=Math.max(0,Math.min(1,playerR.vz/Math.max(1,playerR.maxSpd)));
  const mode=SD.settings.camMode||'chase';

  let behindDist,camHeight,desiredFov;
  switch(mode){
    case 'low':    behindDist=10+speedR*3;camHeight=4.5+speedR*0.8;desiredFov=72+(playerR.isBoosting?16:0)+speedR*14;break;
    case 'wide':   behindDist=22+speedR*8;camHeight=13+speedR*2;desiredFov=80+(playerR.isBoosting?8:0)+speedR*6;break;
    default:       behindDist=15+speedR*5;camHeight=8.2+speedR*1.5+(playerR.isBoosting?0.9:0);desiredFov=65+(playerR.isBoosting?12:0)+speedR*9;
  }

  const desiredX=px;
  const desiredY=camHeight;
  const desiredZ=pz-behindDist;

  let shakeX=0,shakeY=0;
  if(shakeAmt>0){
    shakeY=(Math.random()-0.5)*shakeAmt*1.4;
    shakeX=(Math.random()-0.5)*shakeAmt*0.3;
    shakeAmt=Math.max(0,shakeAmt-dt*6);
  }

  // Weather wind effect on camera
  const windX=currentWeather==='windy'?Math.sin(Date.now()*.001)*0.8:0;
  const windY=currentWeather==='thunderstorm'?Math.sin(Date.now()*.003+0.5)*0.4:0;

  const camLerpSpeed=(6+speedR*3)*dt;
  camState.x+=(desiredX+shakeX+windX-camState.x)*Math.min(1,camLerpSpeed);
  camState.y+=(desiredY+shakeY+windY-camState.y)*Math.min(1,camLerpSpeed*0.8);
  camState.z+=(desiredZ-camState.z)*Math.min(1,camLerpSpeed);

  camera.position.set(camState.x,camState.y,camState.z);

  const lookZ=pz+28+speedR*18;
  const lookX=px+playerR.vx*0.15;
  const desiredLookY=1.5+speedR*0.3;
  const lookLerp=9*dt;
  camState.lx+=(lookX-camState.lx)*Math.min(1,lookLerp);
  camState.ly+=(desiredLookY-camState.ly)*Math.min(1,lookLerp*0.6);
  camState.lz+=(lookZ-camState.lz)*Math.min(1,lookLerp);

  camera.lookAt(camState.lx,camState.ly,camState.lz);
  camState.fov+=(desiredFov-camState.fov)*Math.min(1,dt*4);
  camera.fov=camState.fov;
  camera.updateProjectionMatrix();
}

// â”€â”€ Speedo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const spdCtx=document.getElementById('speedoCanvas').getContext('2d');
function drawSpeedo(spd,max){
  const ctx=spdCtx,w=188,h=115,cx=94,cy=97,r=76;
  ctx.clearRect(0,0,w,h);
  ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,Math.PI*2);ctx.strokeStyle='rgba(255,255,255,.08)';ctx.lineWidth=11;ctx.stroke();
  const pct=Math.min(1,Math.abs(spd)/Math.max(.01,max));
  const col=pct>.82?'#FF2244':pct>.48?'#FFAA00':'#00FFC8';
  ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,Math.PI+Math.PI*pct);ctx.strokeStyle=col;ctx.lineWidth=11;ctx.lineCap='round';ctx.stroke();
  ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,Math.PI+Math.PI*pct);ctx.strokeStyle=col+'44';ctx.lineWidth=20;ctx.stroke();
  for(let t=0;t<=10;t++){const a=Math.PI+t/10*Math.PI;const ir=t%5===0?r-20:r-10;ctx.beginPath();ctx.moveTo(cx+Math.cos(a)*ir,cy+Math.sin(a)*ir);ctx.lineTo(cx+Math.cos(a)*(r-3),cy+Math.sin(a)*(r-3));ctx.strokeStyle=t%5===0?'rgba(255,255,255,.55)':'rgba(255,255,255,.18)';ctx.lineWidth=t%5===0?2.2:1;ctx.stroke();}
  const na=Math.PI+pct*Math.PI;
  ctx.beginPath();ctx.moveTo(cx+Math.cos(na+Math.PI)*11,cy+Math.sin(na+Math.PI)*11);ctx.lineTo(cx+Math.cos(na)*(r-18),cy+Math.sin(na)*(r-18));ctx.strokeStyle='#fff';ctx.lineWidth=2.6;ctx.lineCap='round';ctx.stroke();
  ctx.beginPath();ctx.arc(cx,cy,7,0,Math.PI*2);ctx.fillStyle=col;ctx.fill();
  document.getElementById('speedNum').textContent=Math.round(Math.abs(spd)*3.6);
}

// â”€â”€ Minimap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const mmCv=document.getElementById('mmCanvas');
const mmCtx=mmCv.getContext('2d');
function drawMinimap(){
  const w=160,h=55;
  mmCtx.clearRect(0,0,w,h);
  mmCtx.fillStyle='#020A14';mmCtx.fillRect(0,0,w,h);
  mmCtx.fillStyle='#3A3A3A';mmCtx.fillRect(4,h/2-8,w-8,16);
  if(playerR){const lp=playerR.z/ROAD_LEN;mmCtx.fillStyle='rgba(0,255,200,.28)';mmCtx.fillRect(4,h/2-8,lp*(w-8),16);}
  const fxPos=(ROAD_LEN-20)/ROAD_LEN*(w-8)+4;
  mmCtx.fillStyle='#FFD700';mmCtx.fillRect(fxPos-1.5,h/2-9,3,18);
  mmCtx.fillStyle='rgba(255,255,255,.4)';mmCtx.fillRect(4,h/2-9,3,18);
  racers.forEach(r=>{
    const rz=Math.max(5,Math.min(w-5,r.z/ROAD_LEN*(w-8)+4));
    const rx=(r.x/(ROAD_W*2)+.5)*12+(h/2-6);
    mmCtx.beginPath();mmCtx.arc(rz,rx,r.isP?5:3,0,Math.PI*2);
    mmCtx.fillStyle=r.isP?'#00FFC8':r.def.final?'#FFD700':'#FF4466';mmCtx.fill();
    if(r.isP){mmCtx.strokeStyle='#fff';mmCtx.lineWidth=1.5;mmCtx.stroke();}
  });
  mmCtx.strokeStyle='rgba(0,255,200,.32)';mmCtx.lineWidth=1.5;mmCtx.strokeRect(1,1,w-2,h-2);
}

// â”€â”€ HUD helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHUD(){
  if(!playerR)return;
  drawSpeedo(playerR.vz,playerR.maxSpd);
  document.getElementById('hudCoins').textContent=SD.coins;
  const bP=playerR.boostE/playerR.maxBoost*100;
  document.getElementById('boostPct').textContent=Math.round(bP)+'%';
  document.getElementById('boostFill').style.width=bP+'%';
  document.getElementById('boostFill').style.background=bP<25?'linear-gradient(90deg,#FF2244,#FF2244)':'linear-gradient(90deg,#0088FF,#00FFC8)';
}
function updateHpBar(){
  if(!playerR)return;
  const p=Math.max(0,playerR.armor/playerR.maxArmor*100);
  document.getElementById('hpFill').style.width=p+'%';
  document.getElementById('hpPct').textContent=Math.round(p)+'%';
  document.getElementById('hpFill').style.background=p<30?'linear-gradient(90deg,#FF2244,#FF2244)':'linear-gradient(90deg,#FF2244,#FF8800)';
}
function updateLapUI(){if(!playerR)return;document.getElementById('lapNum').textContent=playerR.lap+' / '+LAP_TOTAL;}
function updatePositions(){
  const sorted=[...racers].sort((a,b)=>{const aD=a.lap*ROAD_LEN+a.z,bD=b.lap*ROAD_LEN+b.z;return bD-aD;});
  sorted.forEach((r,i)=>r.rPos=i+1);
  if(playerR){
    const n=playerR.rPos;
    document.getElementById('posNum').textContent=n;
    document.getElementById('posSuffix').textContent=['ST','ND','RD','TH','TH','TH','TH','TH'][n-1]||'TH';
    document.getElementById('posOf').textContent='of '+racers.length;
    document.getElementById('posNum').style.color=n===1?'#FFD700':n<=3?'#00FFC8':'#FF6688';
  }
}
function updateTimer(dt){raceTime+=dt;const m=Math.floor(raceTime/60),s=Math.floor(raceTime%60);document.getElementById('raceTimer').textContent=m+':'+s.toString().padStart(2,'0');}
function showNotif(txt,col='#FFD700'){const el=document.getElementById('notif');el.textContent=txt;el.style.color=col;el.style.opacity='1';notifTimer=2.2;}
function tickNotif(dt){if(notifTimer>0){notifTimer-=dt;if(notifTimer<=0)document.getElementById('notif').style.opacity='0';}}
function flashDmg(){const el=document.getElementById('damageFlash');el.style.opacity='.88';setTimeout(()=>el.style.opacity='0',110);}
function flashHeal(){const el=document.getElementById('healFlash');el.style.opacity='.88';setTimeout(()=>el.style.opacity='0',300);}
function spawnDmgFloat(pos,amt,type){
  const v=pos.clone().project(camera);
  const x=((v.x+1)/2)*innerWidth,y=((1-v.y)/2)*innerHeight;
  if(x<-50||x>innerWidth+50)return;
  const el=document.createElement('div');el.className='dmg '+type;
  el.textContent=type==='hit'?'-'+Math.round(amt):(type==='coin'?'+'+Math.round(amt)+'ğŸª™':'+'+Math.round(amt));
  el.style.left=x+'px';el.style.top=y+'px';document.body.appendChild(el);
  setTimeout(()=>el.remove(),1300);
}

// NEW: Combo HUD
function updateComboHUD(){
  if(!playerR)return;
  const el=document.getElementById('comboHUD');
  const n=playerR.driftCombo;
  if(n>0){
    el.classList.add('show');
    document.getElementById('comboNum').textContent=n+'x';
    document.getElementById('comboBonus').textContent='+DRIFT BONUS';
  } else {
    el.classList.remove('show');
  }
}

// â”€â”€ Countdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doCountdown(){
  gState='countdown';
  // Show track name
  const T=THEMES[themeIdx];
  const tn=document.getElementById('trackName');
  tn.textContent=T.name.toUpperCase()+' Â· '+weatherData.label;
  tn.style.opacity='1';setTimeout(()=>tn.style.opacity='0',2500);

  let val=3;
  const el=document.getElementById('cdNum');
  const tick=()=>{
    if(val>0){el.textContent=val;el.style.color=val===1?'#FF2244':'#FFD700';el.classList.add('pop');sfx.count(1);setTimeout(()=>el.classList.remove('pop'),750);val--;setTimeout(tick,1000);}
    else{el.textContent='GO!';el.style.color='#00FFC8';el.classList.add('pop');sfx.count(0);setTimeout(()=>el.classList.remove('pop'),1000);gState='racing';lapStartTime=0;}
  };tick();
}

// â”€â”€ Race setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pickWeather(T){
  if(!SD.settings.weather){currentWeather='sunny';weatherData=WEATHERS.sunny;return;}
  const options=T.weather||['sunny'];
  currentWeather=options[Math.floor(Math.random()*options.length)];
  weatherData=WEATHERS[currentWeather]||WEATHERS.sunny;
  // Update weather HUD
  document.getElementById('weatherEmoji').textContent=weatherData.label.split(' ')[0];
  document.getElementById('weatherLabel').textContent=weatherData.label.split(' ').slice(1).join(' ');
  // Rain overlay
  const ro=document.getElementById('rainOverlay');
  if(weatherData.rain>0){ro.style.opacity=weatherData.rain===2?'1':'0.7';initRain(weatherData.rain);}
  else{ro.style.opacity='0';rainParticles=[];}
}

function startRace(ti){
  themeIdx=ti>=0?ti:0;
  raceTime=0;coinsEarned=0;bestLapTime=Infinity;
  raceStats={driftDist:0,maxCombo:0,finishPos:8,noHit:true,boostCount:0,raceCoins:0};
  const T=THEMES[themeIdx];
  pickWeather(T);
  generateRoad(T);
  spawnRacers();
  if(playerR){
    camState.x=playerR.x;camState.y=9;camState.z=playerR.z-16;
    camState.lx=playerR.x;camState.ly=1.5;camState.lz=playerR.z+30;
  }
  camera.position.set(camState.x,camState.y,camState.z);
  camera.lookAt(camState.lx,camState.ly,camState.lz);
  showScreen('game');doCountdown();
}

function spawnRacers(){
  racers.forEach(r=>{if(r.mesh)scene.remove(r.mesh);if(r.shadowMesh)scene.remove(r.shadowMesh);});
  racers=[];playerR=null;
  playerR=new Racer(SD.selectedCar,true,12,4,'YOU');
  racers.push(playerR);
  const names=['Speed Jr','Dax','Moto','Zara','Rex','Nia','Bolt'];
  const cup=CUPS[cupIdx];
  for(let i=0;i<7;i++){
    const lane=i<4?i:(i>=5?i+1:i);
    const bossIdx=cup&&cup.boss!=null?cup.boss:null;
    const ci=i===6&&bossIdx!=null?bossIdx:Math.floor(Math.random()*6);
    const row=Math.floor(i/2);
    const startZ=Math.max(0,10-(row+1)*6);
    racers.push(new Racer(ci,false,startZ,lane%NUM_LANES,names[i]));
  }
}

function startQuickRace(){cupIdx=-1;LAP_TOTAL=3;startRace(Math.floor(Math.random()*4));}

function onPlayerFinish(){
  if(gState==='finished')return;
  gState='finished';updatePositions();
  raceStats.finishPos=playerR.rPos;
  SD.totalRaces++;
  // Challenge progress
  checkChallenges();

  const pos=playerR.rPos;
  coinsEarned=Math.max(0,(8-pos)*75+140);
  SD.coins+=coinsEarned;save();
  if(pos===1){
    document.getElementById('winText').textContent='ğŸ† YOU WIN!';
    document.getElementById('winSub').textContent='1ST PLACE â€” RACE COMPLETE!';
    document.getElementById('winBanner').classList.add('show');
    sfx.victory();
  } else {
    setTimeout(showResults,2000);
  }
}

// NEW: Challenge system
function checkChallenges(){
  CHALLENGE_DEFS.forEach(ch=>{
    if(SD.challenges[ch.id])return; // already done
    let done=false;
    switch(ch.goal){
      case 'driftDist':   done=raceStats.driftDist>=ch.target;break;
      case 'maxCombo':    done=raceStats.maxCombo>=ch.target;break;
      case 'finishPos':   done=raceStats.finishPos<=ch.target;break;
      case 'noHit':       done=raceStats.noHit;break;
      case 'boostCount':  done=raceStats.boostCount>=ch.target;break;
      case 'raceCoins':   done=raceStats.raceCoins>=ch.target;break;
    }
    if(done){SD.challenges[ch.id]=true;SD.coins+=ch.reward;showNotif('ğŸ¯ CHALLENGE: '+ch.name+'! +'+ch.reward+'ğŸª™','#AA00FF');}
  });
  save();
}

function renderChallenges(){
  document.getElementById('challengeGrid').innerHTML=CHALLENGE_DEFS.map(ch=>{
    const done=!!SD.challenges[ch.id];
    return `<div style="background:${done?'rgba(0,255,100,.08)':'rgba(255,255,255,.04)'};border:1.5px solid ${done?'rgba(0,255,100,.4)':'rgba(255,255,255,.1)'};border-radius:12px;padding:16px;text-align:center">
      <div style="font-size:24px;margin-bottom:8px">${done?'âœ…':'ğŸ¯'}</div>
      <div style="font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:1px;color:${done?'#00FF88':'#FFD700'};margin-bottom:5px">${ch.name}</div>
      <div style="font-size:11px;color:rgba(255,255,255,.36);margin-bottom:10px">${ch.desc}</div>
      <div style="font-family:'Orbitron',sans-serif;font-size:13px;color:${done?'rgba(255,255,255,.3)':'#00FFC8'}">${done?'DONE':'ğŸª™ '+ch.reward}</div>
    </div>`;
  }).join('');
}

// â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResults(){
  document.getElementById('winBanner').classList.remove('show');
  showScreen('resultsScreen');
  const sorted=[...racers].sort((a,b)=>a.rPos-b.rPos);
  const pR=playerR.rPos;
  const titles={1:'ğŸ† VICTORY!',2:'ğŸ¥ˆ 2ND PLACE!',3:'ğŸ¥‰ 3RD PLACE!'};
  const tEl=document.getElementById('rTitle');
  tEl.textContent=titles[pR]||'ğŸ RACE OVER';
  tEl.style.color=pR===1?'#FFD700':pR===2?'#C0C0C0':pR===3?'#CD7F32':'#FF4466';
  const pEl=document.getElementById('podiumRow');pEl.innerHTML='';
  const pH=[102,70,50],pC=['#FFD700','#C0C0C0','#CD7F32'],pE=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  sorted.slice(0,3).forEach((r,i)=>{
    const you=r.isP?'<br><small style="color:#00FFC8;font-size:10px">YOU</small>':'';
    pEl.innerHTML+=`<div class="pPlace"><div style="width:62px;height:36px;background:#${(r.def.col||0x888888).toString(16).padStart(6,'0')};border-radius:7px;margin:0 auto 5px"></div><div style="font-size:11px;color:rgba(255,255,255,.5);margin-bottom:4px">${r.name}${you}</div><div class="pBox" style="background:${pC[i]};height:${pH[i]}px">${pE[i]}</div></div>`;
  });
  document.getElementById('rewardBadge').textContent='+'+coinsEarned+' ğŸª™ COINS';
  // NEW: Race stats
  const blt=bestLapTime<Infinity?Math.floor(bestLapTime/60)+':'+(bestLapTime%60).toFixed(2).padStart(5,'0'):'--:--';
  document.getElementById('statRow').innerHTML=`<span>ğŸŒ€ MAX COMBO: ${raceStats.maxCombo}x</span><span>âš¡ BOOSTS: ${raceStats.boostCount}</span><span>ğŸ… BEST LAP: ${blt}</span><span>ğŸª™ COINS: +${raceStats.raceCoins}</span>`;

  let tbl='<thead><tr><th>#</th><th>RACER</th><th>ARMOR</th><th>LAP</th><th>TIME</th></tr></thead><tbody>';
  sorted.forEach((r,i)=>{
    const you=r.isP?' class="you"':'';
    const t=r.finishTime>0?Math.floor(r.finishTime/60)+':'+Math.floor(r.finishTime%60).toString().padStart(2,'0'):'â€”';
    tbl+=`<tr${you}><td>${i+1}</td><td>${r.name}${r.isP?' â˜…':''}</td><td>${Math.round(r.armor)}</td><td>${r.lap}/${LAP_TOTAL}</td><td>${t}</td></tr>`;
  });
  tbl+='</tbody>';document.getElementById('rTable').innerHTML=tbl;
  document.getElementById('nextBtn').style.display=(CUPS[cupIdx]&&raceInCup<CUPS[cupIdx].tracks.length-1)?'block':'none';
}

function nextRace(){if(cupIdx<0)return;const cup=CUPS[cupIdx];raceInCup++;if(raceInCup>=cup.tracks.length){showScreen('titleScreen');return;}LAP_TOTAL=cup.laps;startRace(cup.tracks[raceInCup]);}

// â”€â”€ Shop / Garage / Champ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SHOP=[
  {id:'e0',label:'ENGINE I',   desc:'Speed +1',     price:180,up:'engine',  req:0},
  {id:'e1',label:'ENGINE II',  desc:'Speed +2',     price:380,up:'engine',  req:1},
  {id:'e2',label:'ENGINE MAX', desc:'Top speed',    price:720,up:'engine',  req:2},
  {id:'h0',label:'HANDLING I', desc:'Better steer', price:180,up:'handling',req:0},
  {id:'h1',label:'HANDLING II',desc:'Pro cornering',price:360,up:'handling',req:1},
  {id:'a0',label:'ARMOR I',    desc:'Health +10',   price:200,up:'armor',   req:0},
  {id:'a1',label:'ARMOR II',   desc:'Health +20',   price:440,up:'armor',   req:1},
  {id:'b0',label:'BOOST I',    desc:'Bigger tank',  price:180,up:'boost',   req:0},
  {id:'b1',label:'BOOST II',   desc:'Super boost',  price:350,up:'boost',   req:1},
  {id:'c2',label:'JUNGLE FURY',desc:'Fast & armored',price:250,car:2},
  {id:'c3',label:'ICE BREAKER',desc:'Speed monster',price:450,car:3},
  {id:'c4',label:'LAVA LORD',  desc:'Heavy tank',   price:650,car:4},
  {id:'c5',label:'STORM WING', desc:'Ultimate racer',price:900,car:5},
];
function renderShop(){
  document.getElementById('shopCoins').textContent=SD.coins;
  document.getElementById('shopGrid').innerHTML=SHOP.map(it=>{
    let owned=false,ok=SD.coins>=it.price;
    if(it.car!==undefined)owned=SD.unlockedCars.includes(it.car);
    else if(it.up){owned=SD.upgrades[it.up]>it.req;if(it.req>0&&SD.upgrades[it.up]<it.req)ok=false;}
    return `<div class="si${owned?' owned':''}" onclick="${owned||!ok?'':("buyShop('"+it.id+"')")}"><h4>${it.label}</h4><p>${it.desc}</p><div class="si-price">${owned?'âœ… OWNED':'ğŸª™ '+it.price}</div></div>`;
  }).join('');
}
function buyShop(id){const it=SHOP.find(i=>i.id===id);if(!it||SD.coins<it.price)return;if(it.car!==undefined){if(SD.unlockedCars.includes(it.car))return;SD.unlockedCars.push(it.car);}else if(it.up){if(SD.upgrades[it.up]>it.req)return;SD.upgrades[it.up]++;}SD.coins-=it.price;save();sfx.pickup();renderShop();}
function renderGarage(){
  document.getElementById('carGrid').innerHTML=CARS.slice(0,6).map((c,i)=>{
    const ul=SD.unlockedCars.includes(i),sel=SD.selectedCar===i;
    const pips=v=>'<div class="spips">'+Array.from({length:10},(_,j)=>`<div class="pip${j<v?' on':''}"></div>`).join('')+'</div>';
    return `<div class="cc${sel?' sel':''}${ul?'':' locked'}" onclick="${ul?`selCar(${i})`:''}"><div class="cpb" style="background:linear-gradient(135deg,#${(c.col2||0x111).toString(16).padStart(6,'0')},#${c.col.toString(16).padStart(6,'0')})"></div><h4>${c.name}</h4>${pips(c.spd)}<div style="font-size:10px;color:${ul?(sel?'var(--gold)':'var(--neon)'):'#FF2244'};margin-top:5px;letter-spacing:1px">${ul?(sel?'âœ… SELECTED':'SELECT'):'ğŸ”’ SHOP'}</div></div>`;
  }).join('');
}
function selCar(i){SD.selectedCar=i;save();sfx.pickup();renderGarage();}
function renderChamp(){
  document.getElementById('cupGrid').innerHTML=CUPS.map((c,i)=>{
    const stars=SD.champ['c'+i]||0,locked=i>0&&!(SD.champ['c'+(i-1)]>0);
    return `<div class="cuc${locked?' lkd':''}" onclick="${locked?'':(`startCup(${i})`)}"><h3>${c.name}</h3><div style="color:rgba(255,255,255,.32);font-size:11px;margin:4px 0">${c.tracks.map(t=>THEMES[t].name).join(' â†’ ')}</div>${c.boss!=null?`<div style="color:#FF4466;font-size:11px">Boss: ${CARS[c.boss].name}</div>`:''}<div style="font-size:22px;margin-top:9px">${'â­'.repeat(stars)+'â˜†'.repeat(3-stars)}</div>${locked?'<div style="color:var(--red);font-size:10px;margin-top:5px">Win previous cup first</div>':''}</div>`;
  }).join('');
}
function startCup(ci){cupIdx=ci;raceInCup=0;LAP_TOTAL=CUPS[ci].laps;startRace(CUPS[ci].tracks[0]);}
function loadSettings(){
  document.getElementById('diffSel').value=SD.settings.difficulty;
  const cs=document.getElementById('camSel');if(cs)cs.value=SD.settings.camMode||'chase';
  const b=document.getElementById('sfxT');b.textContent=SD.settings.sfx?'ON':'OFF';b.className=SD.settings.sfx?'tog on':'tog';
  const sh=document.getElementById('shadowT');if(sh){sh.textContent=SD.settings.shadows?'ON':'OFF';sh.className=SD.settings.shadows?'tog on':'tog';}
  const wt=document.getElementById('weatherT');if(wt){wt.textContent=SD.settings.weather?'ON':'OFF';wt.className=SD.settings.weather?'tog on':'tog';}
}

// â”€â”€ Screen manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCREENS=['titleScreen','champScreen','garageScreen','shopScreen','settingsScreen','resultsScreen','pauseScreen','challengeScreen'];
const SCREEN_INIT={shopScreen:renderShop,garageScreen:renderGarage,champScreen:renderChamp,settingsScreen:loadSettings,challengeScreen:renderChallenges};
function showScreen(id){
  SCREENS.forEach(s=>document.getElementById(s).classList.add('off'));
  document.getElementById('hud').classList.add('off');
  document.getElementById('touchCtrl').style.display='none';
  document.getElementById('winBanner').classList.remove('show');
  if(id==='game'){
    document.getElementById('hud').classList.remove('off');
    document.getElementById('touchCtrl').style.display='flex';
    if(gState==='menu')gState='racing';
  } else {
    if(SCREEN_INIT[id])SCREEN_INIT[id]();
    document.getElementById(id).classList.remove('off');
  }
}
function useItem(){if(playerR&&playerR.item)playerR.fireItem();}
function resumeGame(){paused=false;gState='racing';showScreen('game');}

// â”€â”€ Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const keys={};
window.addEventListener('keydown',e=>{
  keys[e.code]=true;
  if(e.code==='Space'){e.preventDefault();if(gState==='racing')useItem();}
  if(e.code==='KeyC'&&gState==='racing'){
    // Cycle camera
    const modes=['chase','low','wide'];
    const cur=SD.settings.camMode||'chase';
    const next=modes[(modes.indexOf(cur)+1)%modes.length];
    SD.settings.camMode=next;save();showNotif('ğŸ“· '+next.toUpperCase()+' CAM','#00FFC8');
  }
  if(e.code==='Escape'){
    if(gState==='racing'){paused=true;gState='paused';
      document.getElementById('pauseStats').textContent='TIME: '+document.getElementById('raceTimer').textContent+'  |  POS: '+playerR.rPos+'/8';
      showScreen('pauseScreen');}
    else if(gState==='paused')resumeGame();
    else if(gState==='finished')showScreen('titleScreen');
  }
});
window.addEventListener('keyup',e=>{keys[e.code]=false;});
window.addEventListener('mousemove',e=>e.stopPropagation(),true);

function getInput(){
  return{
    f:    keys['ArrowUp']   ||keys['KeyW']||td.f,
    b:    keys['ArrowDown'] ||keys['KeyS']||td.b,
    l:    keys['ArrowLeft'] ||keys['KeyA']||td.l,
    r:    keys['ArrowRight']||keys['KeyD']||td.r,
    boost:keys['ShiftLeft'] ||keys['ShiftRight']||keys['KeyX']||td.boost
  };
}

// â”€â”€ Menu scene â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const menuScene=new THREE.Scene();
const menuCam=new THREE.PerspectiveCamera(58,innerWidth/innerHeight,.1,600);
menuCam.position.set(0,7,0);menuCam.lookAt(0,1,30);
let menuCars=[];
(function setupMenu(){
  menuScene.background=new THREE.Color(0x000c1a);
  menuScene.fog=new THREE.Fog(0x000c1a,80,220);
  menuScene.add(new THREE.AmbientLight(0xFFFFFF,.55));
  const dl=new THREE.DirectionalLight(0xFFD700,1.4);dl.position.set(28,38,-10);menuScene.add(dl);
  const dl2=new THREE.DirectionalLight(0x4488FF,.55);dl2.position.set(-28,20,10);menuScene.add(dl2);
  const road=new THREE.Mesh(new THREE.PlaneGeometry(50,600),new THREE.MeshPhongMaterial({color:0x777777,shininess:20}));
  road.rotation.x=-Math.PI/2;road.position.set(0,-1.5,300);menuScene.add(road);
  const gnd=new THREE.Mesh(new THREE.PlaneGeometry(600,600),new THREE.MeshPhongMaterial({color:0x0A1A0A}));
  gnd.rotation.x=-Math.PI/2;gnd.position.set(0,-1.75,300);menuScene.add(gnd);
  const oc=new THREE.Mesh(new THREE.PlaneGeometry(100,600),new THREE.MeshPhongMaterial({color:0x0066AA,transparent:true,opacity:.55,shininess:200}));
  oc.rotation.x=-Math.PI/2;oc.position.set(-60,-1.9,300);menuScene.add(oc);
  CARS.slice(0,6).forEach((cd,i)=>{
    const m=buildCarMesh(cd);m.scale.setScalar(1.1);
    const startZ=80+i*35,lx=(i%4)*10-15;
    m.position.set(lx,-1,startZ);m.rotation.y=Math.PI;
    menuScene.add(m);menuCars.push({mesh:m,spd:0.25+cd.spd*.01,z:startZ,x:lx});
  });
  const sg=new THREE.BufferGeometry();const sv=[];
  for(let i=0;i<700;i++)sv.push((Math.random()-.5)*500,(Math.random()-.5)*300+60,Math.random()*500);
  sg.setAttribute('position',new THREE.Float32BufferAttribute(sv,3));
  menuScene.add(new THREE.Points(sg,new THREE.PointsMaterial({color:0xFFFFFF,size:.65})));
  for(let z=10;z<200;z+=32){
    [-28,28].forEach(x=>{const p=mkPalm(0,0,0);p.position.set(x,-1.5,z);p.scale.setScalar(1.4);menuScene.add(p);});
  }
  CARS.slice(0,4).forEach((cd,i)=>{const lp=new THREE.PointLight(cd.col,.38,55);lp.position.set(Math.cos(i/4*Math.PI*2)*40,15,80+Math.sin(i/4*Math.PI*2)*20);menuScene.add(lp);});
})();

// â”€â”€ Main loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastT=0;
function loop(t){
  requestAnimationFrame(loop);
  const dt=Math.min((t-lastT)/1000,0.05);lastT=t;

  if(gState==='menu'){
    menuCars.forEach(c=>{
      c.z-=c.spd*dt*35;if(c.z<-5)c.z=120+Math.random()*80;
      c.mesh.position.z=c.z;
      const ws=c.mesh.userData.wheels;
      if(ws)ws.forEach(w=>{w.children[0].rotation.x-=dt*5*c.spd;w.children[1].rotation.x-=dt*5*c.spd;});
    });
    menuCam.position.set(0,7,0);menuCam.lookAt(0,1,35);
    renderer.render(menuScene,menuCam);return;
  }

  if(gState==='countdown'){
    if(playerR){
      camState.x+=(playerR.x-camState.x)*Math.min(1,dt*5);
      camState.z+=(playerR.z-16-camState.z)*Math.min(1,dt*5);
      camera.position.set(camState.x,9,camState.z);
      camera.lookAt(playerR.x,1.5,playerR.z+28);
    }
    renderer.render(scene,camera);return;
  }

  if(gState==='racing'){
    const inp=getInput();
    racers.forEach(r=>r.update(dt,r.isP?inp:null));
    updatePositions();
    updateCamera(dt);
    updateHUD();
    updateTimer(dt);
    updateProjectiles(dt);
    updateFX(dt);
    tickNotif(dt);
    drawMinimap();
    // Rain
    if(weatherData.rain>0)drawRain(dt);
    // Lightning flash
    if(currentWeather==='thunderstorm'&&Math.random()<0.003){
      const lf=document.getElementById('lapFlash');lf.style.background='rgba(200,220,255,.25)';lf.style.opacity='.9';setTimeout(()=>{lf.style.opacity='0';lf.style.background='rgba(255,215,0,.13)';},80);
      sfx.explode();
    }
    if(!playerR.finished&&racers.filter(r=>!r.isP).every(r=>r.finished)){playerR.finished=true;onPlayerFinish();}
  }

  if(gState!=='menu')renderer.render(scene,camera);
}
loop(0);

showScreen('titleScreen');gState='menu';
console.log('%cğŸ–ï¸ BRU KART RACING v3.0 â€” Beach Buggy Enhanced  |  INEZA AIME BRUNO','color:#FFD700;font-size:16px;font-weight:900');
console.log('%cNEW: Weather System Â· Drift Combos Â· Challenges Â· 3 Camera Modes Â· Wrong Way Â· Oil Slick Â· Triple Fire Â· Position Swap','color:#00FFC8');
console.log('%câ†‘/W=Gas  â†“/S=Brake  â†â†’=Steer  Shift=Boost  Space=Item  C=Camera  Esc=Pause','color:#aaaaff');
</script>
</body>
</html>
